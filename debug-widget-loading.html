<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Widget Loading</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .debug-info { 
            background: #000; 
            color: #0f0; 
            padding: 15px; 
            margin: 10px 0;
            border-radius: 5px;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .test-section {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>Widget Loading Debug</h1>
    
    <div class="test-section">
        <h3>Test Script Loading Method</h3>
        <button onclick="loadScriptViaTag()">Load via Script Tag</button>
        <button onclick="loadScriptViaDynamic()">Load via JavaScript</button>
        <button onclick="checkCurrentState()">Check Current State</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="test-section">
        <h3>Current State</h3>
        <div id="state-info" class="debug-info">Click "Check Current State" to see status</div>
    </div>

    <div class="test-section">
        <h3>Debug Logs</h3>
        <div id="debug-logs" class="debug-info">Waiting for actions...</div>
    </div>

    <script>
        let logs = [];
        
        function logMessage(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f66' : type === 'success' ? '#6f6' : '#fff';
            const entry = `[${timestamp}] ${msg}`;
            logs.push(entry);
            
            const logDiv = document.getElementById('debug-logs');
            logDiv.innerHTML = logs.map(log => `<div style="color: ${color}">${log}</div>`).join('');
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(`[DEBUG] ${entry}`);
        }

        function clearLogs() {
            logs = [];
            document.getElementById('debug-logs').innerHTML = 'Logs cleared...';
        }

        function checkCurrentState() {
            const state = {
                PicassoWidget: !!window.PicassoWidget,
                widgetContainer: !!document.getElementById('picasso-widget-container'),
                widgetScriptsInDOM: document.querySelectorAll('script[src*="widget"]').length,
                iframeExists: !!document.querySelector('#picasso-widget-container iframe'),
                currentScripts: Array.from(document.querySelectorAll('script')).map(s => s.src).filter(s => s),
                location: window.location.href,
                readyState: document.readyState
            };

            if (window.PicassoWidget && typeof window.PicassoWidget.health === 'function') {
                try {
                    state.health = window.PicassoWidget.health();
                } catch (e) {
                    state.healthError = e.message;
                }
            }

            const iframe = document.querySelector('#picasso-widget-container iframe');
            if (iframe) {
                state.iframeSrc = iframe.src;
                state.iframeSize = {
                    width: iframe.clientWidth,
                    height: iframe.clientHeight
                };
            }

            document.getElementById('state-info').innerHTML = '<pre>' + JSON.stringify(state, null, 2) + '</pre>';
            logMessage('State check completed', 'info');
        }

        function loadScriptViaTag() {
            logMessage('Attempting to load widget.js via script tag...', 'info');
            
            // Remove any existing script tags
            const existingScripts = document.querySelectorAll('script[src*="widget.js"]');
            existingScripts.forEach(script => {
                logMessage(`Removing existing script: ${script.src}`, 'info');
                script.remove();
            });

            const script = document.createElement('script');
            script.src = '/widget.js';
            script.setAttribute('data-tenant', 'my87674d777bf9');
            
            script.onload = () => {
                logMessage('‚úÖ Script loaded successfully via tag', 'success');
                setTimeout(checkCurrentState, 100);
            };
            
            script.onerror = (e) => {
                logMessage('‚ùå Script failed to load via tag: ' + e.message, 'error');
            };
            
            document.head.appendChild(script);
        }

        function loadScriptViaDynamic() {
            logMessage('Attempting to load widget.js via dynamic loading...', 'info');
            
            // Remove any existing PicassoWidget
            if (window.PicassoWidget) {
                logMessage('Cleaning up existing PicassoWidget...', 'info');
                if (typeof window.PicassoWidget.destroy === 'function') {
                    window.PicassoWidget.destroy();
                }
                delete window.PicassoWidget;
            }

            // Remove container
            const existingContainer = document.getElementById('picasso-widget-container');
            if (existingContainer) {
                logMessage('Removing existing container...', 'info');
                existingContainer.remove();
            }

            // Fetch and execute script
            fetch('/widget.js')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    logMessage(`‚úÖ Fetched script successfully (${response.status})`, 'success');
                    return response.text();
                })
                .then(scriptText => {
                    logMessage('Script content length: ' + scriptText.length, 'info');
                    
                    // Create and execute script
                    const script = document.createElement('script');
                    script.setAttribute('data-tenant', 'my87674d777bf9');
                    script.textContent = scriptText;
                    document.head.appendChild(script);
                    
                    logMessage('‚úÖ Script executed successfully', 'success');
                    setTimeout(checkCurrentState, 100);
                })
                .catch(error => {
                    logMessage('‚ùå Failed to fetch/execute script: ' + error.message, 'error');
                });
        }

        // Listen for all window events
        window.addEventListener('message', (event) => {
            logMessage(`üì® Message received: ${event.data.type} from ${event.origin}`, 'info');
        });

        // Listen for script errors
        window.addEventListener('error', (event) => {
            logMessage(`‚ùå Global error: ${event.message} at ${event.filename}:${event.lineno}`, 'error');
        });

        // Monitor DOM changes
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) { // Element node
                            if (node.tagName === 'DIV' && node.id === 'picasso-widget-container') {
                                logMessage('üéØ Widget container added to DOM', 'success');
                            }
                            if (node.tagName === 'IFRAME' && node.id === 'picasso-widget-iframe') {
                                logMessage('üñºÔ∏è Widget iframe added to DOM', 'success');
                            }
                        }
                    });
                }
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        logMessage('Debug page loaded and monitoring started', 'info');
    </script>
</body>
</html>