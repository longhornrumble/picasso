AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'EMERGENCY SECURITY DEPLOYMENT - Cross-Tenant Access Protection - P0 Priority'

Parameters:
  Environment:
    Type: String
    AllowedValues: [staging, production]
    Default: staging
    Description: Target environment for emergency deployment
  
  ExistingALBArn:
    Type: String
    Description: ARN of existing Application Load Balancer
    Default: "arn:aws:elasticloadbalancing:us-east-1:123456789012:loadbalancer/app/picasso-alb/1234567890abcdef"
  
  ExistingListenerArn:
    Type: String
    Description: ARN of existing ALB listener
    Default: "arn:aws:elasticloadbalancing:us-east-1:123456789012:listener/app/picasso-alb/1234567890abcdef/1234567890abcdef"

  VPCId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID for security group deployment
  
  ExistingApiGatewayId:
    Type: String
    Description: Existing API Gateway ID to attach circuit breakers
    Default: "abcd123456"

Conditions:
  IsProduction: !Equals [!Ref Environment, production]

Resources:
  # PRIORITY 1: EMERGENCY ALB RULES - Block cross-tenant access patterns
  BlockCrossTenantRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref ExistingListenerArn
      Priority: 100
      Actions:
        - Type: fixed-response
          FixedResponseConfig:
            StatusCode: '403'
            ContentType: 'application/json'
            MessageBody: |
              {
                "error": "Access denied - Security protection active",
                "code": "CROSS_TENANT_BLOCKED",
                "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
              }
      Conditions:
        - Field: query-string
          QueryStringConfig:
            Values:
              - Key: "t"
                Value: "my87674d777bf9"  # Block production hash in staging

  BlockSuspiciousPatterns:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule  
    Properties:
      ListenerArn: !Ref ExistingListenerArn
      Priority: 101
      Actions:
        - Type: fixed-response
          FixedResponseConfig:
            StatusCode: '403'
            ContentType: 'application/json'
            MessageBody: |
              {
                "error": "Suspicious access pattern detected",
                "code": "SECURITY_BLOCK",
                "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
              }
      Conditions:
        - Field: path-pattern
          Values:
            - "*/tenant/*"
            - "*/config/*"
        - Field: query-string
          QueryStringConfig:
            Values:
              - Key: "environment"
                Value: "*"

  # PRIORITY 1: VPC SECURITY GROUPS - Network-level isolation
  CrossTenantIsolationSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub "${Environment}-emergency-tenant-isolation"
      GroupDescription: "Emergency security group for cross-tenant isolation"
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: "HTTPS only - monitored"
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: "HTTP redirect only"
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: "Outbound HTTPS only"
      Tags:
        - Key: Name
          Value: !Sub "${Environment}-emergency-security"
        - Key: Purpose
          Value: "P0-CrossTenant-Protection"
        - Key: DeployedBy
          Value: "EmergencySecurityTeam"

  # PRIORITY 1: NETWORK ACL - Additional network-level protection
  EmergencyNetworkACL:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref VPCId
      Tags:
        - Key: Name
          Value: !Sub "${Environment}-emergency-nacl"
        - Key: Purpose
          Value: "Cross-tenant-isolation"

  # Block suspicious cross-tenant traffic patterns
  DenyMaliciousInbound:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref EmergencyNetworkACL
      RuleNumber: 100
      Protocol: 6  # TCP
      RuleAction: deny
      PortRange:
        From: 8080
        To: 8099
      CidrBlock: 0.0.0.0/0

  AllowHTTPSInbound:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref EmergencyNetworkACL
      RuleNumber: 200
      Protocol: 6  # TCP
      RuleAction: allow
      PortRange:
        From: 443
        To: 443
      CidrBlock: 0.0.0.0/0

  # PRIORITY 2: API GATEWAY CIRCUIT BREAKERS
  RequestValidator:
    Type: AWS::ApiGateway::RequestValidator
    Properties:
      RestApiId: !Ref ExistingApiGatewayId
      Name: !Sub "${Environment}-emergency-validator"
      ValidateRequestParameters: true
      ValidateRequestBody: true

  # Throttling for suspicious patterns
  UsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Properties:
      UsagePlanName: !Sub "${Environment}-emergency-throttling"
      Description: "Emergency throttling for security protection"
      Throttle:
        BurstLimit: 10
        RateLimit: 5
      Quota:
        Limit: 1000
        Period: DAY
      Tags:
        - Key: Purpose
          Value: "Emergency-Security-Throttling"

  # PRIORITY 2: ENHANCED CLOUDWATCH MONITORING
  CrossTenantAccessAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${Environment}-CrossTenantAccessAttempt"
      AlarmDescription: "CRITICAL: Cross-tenant access attempt detected"
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      MetricName: "4XXError"
      Namespace: "AWS/ApplicationELB"
      Period: 60
      Statistic: Sum
      Threshold: 0
      Dimensions:
        - Name: LoadBalancer
          Value: !Ref ExistingALBArn
      AlarmActions:
        - !Ref SecurityNotificationTopic
      TreatMissingData: notBreaching
      Tags:
        - Key: Severity
          Value: "P0-Critical"
        - Key: AlertType
          Value: "Security-Breach"

  SecurityBreachAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${Environment}-SecurityBreachAttempt"
      AlarmDescription: "CRITICAL: Security breach attempt - immediate escalation required"
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      MetricName: "RequestCount"
      Namespace: "AWS/ApiGateway"
      Period: 300
      Statistic: Sum
      Threshold: 50  # Threshold for suspicious activity
      Dimensions:
        - Name: ApiName
          Value: !Sub "${Environment}-picasso-api"
      AlarmActions:
        - !Ref SecurityNotificationTopic
        - !Ref SecurityEscalationTopic

  # PRIORITY 3: EMERGENCY SNS ALERTS
  SecurityNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "${Environment}-security-alerts"
      DisplayName: "Emergency Security Alerts"
      Tags:
        - Key: Purpose
          Value: "P0-Security-Notifications"

  SecurityEscalationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "${Environment}-security-escalation"
      DisplayName: "Critical Security Escalation"
      Tags:
        - Key: Purpose
          Value: "P0-Security-Escalation"

  # Email subscription for immediate alerts
  SecurityAlertSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: email
      TopicArn: !Ref SecurityNotificationTopic
      Endpoint: "security-team@myrecruiter.ai"

  # SMS subscription for critical escalation
  SecurityEscalationSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sms
      TopicArn: !Ref SecurityEscalationTopic
      Endpoint: "+1234567890"  # Replace with actual security team number

  # CUSTOM METRICS FOR REAL-TIME MONITORING
  CrossTenantMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-Master-Function"
      FilterPattern: "[timestamp, requestId, level=\"ERROR\", message=\"*cross*tenant*\" || message=\"*unauthorized*access*\"]"
      MetricTransformations:
        - MetricNamespace: "Security/CrossTenant"
          MetricName: "UnauthorizedAccess"
          MetricValue: "1"
          DefaultValue: 0

  # WAF Web ACL for additional protection
  WebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: !Sub "${Environment}-emergency-waf"
      Scope: REGIONAL
      DefaultAction:
        Allow: {}
      Rules:
        - Name: BlockCrossTenantQueries
          Priority: 1
          Statement:
            ByteMatchStatement:
              FieldToMatch:
                UriPath: {}
              SearchString: "t=my87674d777bf9"
              TextTransformations:
                - Priority: 0
                  Type: URL_DECODE
          Action:
            Block:
              CustomResponse:
                ResponseCode: 403
                CustomResponseBodyKey: CrossTenantBlock
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: CrossTenantBlocked
      CustomResponseBodies:
        CrossTenantBlock:
          ContentType: APPLICATION_JSON
          Content: |
            {
              "error": "Cross-tenant access blocked",
              "incident_id": "$(uuid)",
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }
      Tags:
        - Key: Purpose
          Value: "Emergency-Security-Protection"

Outputs:
  SecurityGroupId:
    Description: "Emergency security group ID for network isolation"
    Value: !Ref CrossTenantIsolationSecurityGroup
    Export:
      Name: !Sub "${Environment}-emergency-security-group"

  SecurityNotificationTopicArn:
    Description: "SNS topic for security notifications"
    Value: !Ref SecurityNotificationTopic
    Export:
      Name: !Sub "${Environment}-security-notifications"

  WebACLArn:
    Description: "WAF Web ACL for additional protection"
    Value: !GetAtt WebACL.Arn
    Export:
      Name: !Sub "${Environment}-emergency-waf"

  DeploymentStatus:
    Description: "Emergency deployment status"
    Value: !Sub "P0 Security controls deployed for ${Environment} at $(date -u)"