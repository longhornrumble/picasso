<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1D4ED8" />
    
    <title>Picasso Widget</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" /></noscript>
    
    <style>
      *,*::before,*::after{box-sizing:border-box;}
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        font-family: Inter, system-ui, -apple-system, sans-serif;
        background: transparent;
      }
      
      #root {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      
      .loading-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        background: #f8f9fa;
        color: #6c757d;
        font-family: Inter, system-ui, -apple-system, sans-serif;
        font-size: 14px;
        flex-direction: column;
      }
      
      .spinner{width:32px;height:32px;border:3px solid #f3f4f6;border-radius:50%;border-top-color:#1d4ed8;animation:spin 1s ease-in-out infinite;margin-bottom:10px;}
      @keyframes spin{to{transform:rotate(360deg);}}
    </style>
  </head>
<body>
  <div id="root">
    <div class="loading-indicator">
      <div class="spinner"></div>
      Loading Widget...
    </div>
  </div>

  <script>
    // Communication bridge with parent window
    function notifyParent(data) {
      if (window.parent && window.parent !== window) {
        // Convert legacy SIZE_CHANGE action to PICASSO_EVENT format
        if (data.action === 'SIZE_CHANGE') {
          window.parent.postMessage({
            type: 'PICASSO_EVENT',
            event: 'RESIZE_REQUEST',
            payload: {
              dimensions: data.size,
              isOpen: data.isOpen
            }
          }, '*');
        } else {
          // For any other legacy messages, keep as-is for now
          window.parent.postMessage({
            type: 'PICASSO_WIDGET',
            ...data
          }, '*');
        }
      }
    }

    // Monitor chat state changes for iframe resizing
    function setupStateMonitoring() {
      // Ensure document.body exists and is properly initialized
      if (!document || !document.body || typeof document.body.classList === 'undefined') {
        setTimeout(setupStateMonitoring, 100);
        return;
      }
      
      let lastOpenState = null;
      
      // Function to check and notify state changes
      function checkStateChange() {
        try {
          const isOpen = document.body.classList.contains('chat-open');
          if (isOpen !== lastOpenState) {
            lastOpenState = isOpen;
            notifyParent({
              action: 'SIZE_CHANGE',
              isOpen: isOpen,
              size: isOpen ? { width: 368, height: 648 } : { width: 56, height: 56 }
            });
          }
        } catch (error) {
          // Silently handle errors
        }
      }
      
      // Try MutationObserver first (preferred)
      if (typeof MutationObserver !== 'undefined') {
        try {
          const observer = new MutationObserver((mutations) => {
            for (const mutation of mutations) {
              if (mutation.type === 'attributes' && 
                  mutation.attributeName === 'class' && 
                  mutation.target === document.body) {
                checkStateChange();
                break;
              }
            }
          });

          observer.observe(document.body, {
            attributes: true,
            attributeFilter: ['class'],
            subtree: false
          });
        } catch (error) {
          // Fallback to polling
          setInterval(checkStateChange, 200);
        }
      } else {
        setInterval(checkStateChange, 200);
      }
      
      // Initial state check
      setTimeout(checkStateChange, 100);
    }

    // Initialize monitoring when DOM is ready
    function initializeWhenReady() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(setupStateMonitoring, 50);
        });
      } else {
        setTimeout(setupStateMonitoring, 50);
      }
    }
    
    // Initialize
    initializeWhenReady();
  </script>
  
  <!-- Load the React application -->
  <script type="module" src="/src/iframe-main.jsx"></script>
</body>
</html>