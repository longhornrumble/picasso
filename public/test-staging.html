<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Picasso Staging Test Page - Master_Function_Staging</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }
        
        .status-indicator.active {
            background: #4caf50;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.error {
            background: #f44336;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 968px) {
            .test-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .test-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .test-card h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .test-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-group label {
            font-size: 14px;
            color: #666;
            min-width: 120px;
        }
        
        .control-group input, .control-group select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .console-output {
            background: #1e1e1e;
            color: #0f0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .console-line {
            margin-bottom: 4px;
            display: flex;
            align-items: flex-start;
        }
        
        .console-time {
            color: #888;
            margin-right: 8px;
            min-width: 80px;
        }
        
        .console-level {
            margin-right: 8px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .console-level.info { background: #2196F3; color: white; }
        .console-level.success { background: #4caf50; color: white; }
        .console-level.error { background: #f44336; color: white; }
        .console-level.warning { background: #ff9800; color: white; }
        
        .widget-container {
            position: relative;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .widget-placeholder {
            text-align: center;
            color: #999;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .metric-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .test-list {
            list-style: none;
            margin-top: 15px;
        }
        
        .test-list li {
            padding: 10px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-list .passed {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .test-list .failed {
            background: #ffebee;
            color: #c62828;
        }
        
        .test-list .pending {
            background: #fff3e0;
            color: #e65100;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ Picasso Staging Test Suite</h1>
            <p style="color: #666; margin-top: 5px;">Testing Master_Function_Staging Lambda Integration</p>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="server-status"></div>
                    <span>Dev Server</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="lambda-status"></div>
                    <span>Lambda</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="widget-status"></div>
                    <span>Widget</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="streaming-status"></div>
                    <span>Streaming</span>
                </div>
                <div class="status-item">
                    <span id="environment-label">Environment: STAGING</span>
                </div>
            </div>
        </div>
        
        <!-- Test Controls Grid -->
        <div class="test-grid">
            <!-- Widget Configuration -->
            <div class="test-card">
                <h2>üìã Widget Configuration</h2>
                <div class="test-controls">
                    <div class="control-group">
                        <label>Tenant Hash:</label>
                        <input type="text" id="tenant-hash" value="my87674d777bf9" placeholder="Enter tenant hash">
                    </div>
                    <div class="control-group">
                        <label>API Endpoint:</label>
                        <select id="api-endpoint">
                            <option value="staging" selected>Staging (Master_Function_Staging)</option>
                            <option value="production">Production (Master_Function)</option>
                            <option value="local">Local Development</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Widget Source:</label>
                        <select id="widget-source">
                            <option value="local" selected>Local (http://localhost:8000)</option>
                            <option value="staging-cdn">Staging CDN</option>
                            <option value="production-cdn">Production CDN</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="loadWidget()">Load Widget</button>
                        <button class="btn btn-secondary" onclick="reloadWidget()">Reload</button>
                        <button class="btn btn-danger" onclick="removeWidget()">Remove</button>
                    </div>
                </div>
            </div>
            
            <!-- Test Suite -->
            <div class="test-card">
                <h2>üß™ Automated Tests</h2>
                <div class="test-controls">
                    <button class="btn btn-primary" onclick="runAllTests()">Run All Tests</button>
                    <button class="btn btn-secondary" onclick="runConfigTest()">Test Config</button>
                    <button class="btn btn-secondary" onclick="runChatTest()">Test Chat</button>
                    <button class="btn btn-secondary" onclick="runStreamingTest()">Test Streaming</button>
                    
                    <ul class="test-list" id="test-results">
                        <li class="pending">‚è≥ Lambda Health Check</li>
                        <li class="pending">‚è≥ Configuration Loading</li>
                        <li class="pending">‚è≥ Session Initialization</li>
                        <li class="pending">‚è≥ Chat Message Flow</li>
                        <li class="pending">‚è≥ Streaming Response</li>
                        <li class="pending">‚è≥ Error Handling</li>
                        <li class="pending">‚è≥ CORS Headers</li>
                        <li class="pending">‚è≥ Conversation Memory</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Widget Display and Console -->
        <div class="test-grid">
            <!-- Widget Container -->
            <div class="test-card">
                <h2>üí¨ Widget Display</h2>
                <div class="widget-container" id="widget-container">
                    <div class="widget-placeholder">
                        <p>Widget will appear here</p>
                        <p style="color: #bbb; font-size: 14px; margin-top: 10px;">Click "Load Widget" to begin</p>
                    </div>
                </div>
            </div>
            
            <!-- Console & Metrics -->
            <div class="test-card">
                <h2>üìä Metrics & Console</h2>
                <div class="metrics-grid">
                    <div class="metric-box">
                        <div class="metric-value" id="load-time">-</div>
                        <div class="metric-label">Load Time (ms)</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value" id="api-calls">0</div>
                        <div class="metric-label">API Calls</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value" id="messages-sent">0</div>
                        <div class="metric-label">Messages</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value" id="error-count">0</div>
                        <div class="metric-label">Errors</div>
                    </div>
                </div>
                <div class="console-output" id="console">
                    <div class="console-line">
                        <span class="console-time">[00:00:00]</span>
                        <span class="console-level info">INFO</span>
                        <span>Console initialized - Ready for testing</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Advanced Testing -->
        <div class="test-card">
            <h2>üîß Advanced Testing</h2>
            <div class="test-controls">
                <div class="control-group">
                    <label>Test Message:</label>
                    <input type="text" id="test-message" value="Hello, I need help with my account" placeholder="Enter test message">
                    <button class="btn btn-primary" onclick="sendTestMessage()">Send</button>
                </div>
                <div class="control-group">
                    <label>Session ID:</label>
                    <input type="text" id="session-id" placeholder="Auto-generated" readonly>
                    <button class="btn btn-secondary" onclick="generateNewSession()">New Session</button>
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="testHealthCheck()">Health Check</button>
                    <button class="btn btn-secondary" onclick="testConfig()">Get Config</button>
                    <button class="btn btn-secondary" onclick="testInitSession()">Init Session</button>
                    <button class="btn btn-secondary" onclick="testJWT()">Test JWT</button>
                    <button class="btn btn-secondary" onclick="clearConsole()">Clear Console</button>
                    <button class="btn btn-success" onclick="exportTestResults()">Export Results</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration
        const STAGING_API = 'https://xo6tsuhi6u2fby3rkw4usa663q0igxjk.lambda-url.us-east-1.on.aws';
        const STAGING_STREAMING = 'https://7pluzq3axftklmb4gbgchfdahu0lcnqd.lambda-url.us-east-1.on.aws';
        const PRODUCTION_API = 'https://uia3tfv4ockwdsosk2rpj7qvoy0riobe.lambda-url.us-east-1.on.aws';
        
        let widgetLoaded = false;
        let sessionId = null;
        let apiCallCount = 0;
        let messageCount = 0;
        let errorCount = 0;
        let startTime = null;
        
        // Console logging
        function log(message, level = 'info') {
            const console = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = 'console-line';
            line.innerHTML = `
                <span class="console-time">[${time}]</span>
                <span class="console-level ${level}">${level.toUpperCase()}</span>
                <span>${message}</span>
            `;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
            
            if (level === 'error') {
                errorCount++;
                document.getElementById('error-count').textContent = errorCount;
            }
        }
        
        // Clear console
        function clearConsole() {
            document.getElementById('console').innerHTML = '';
            log('Console cleared', 'info');
        }
        
        // Update status indicators
        function updateStatus(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = 'status-indicator ' + status;
        }
        
        // Load widget
        function loadWidget() {
            log('Loading widget...', 'info');
            startTime = Date.now();
            
            const tenantHash = document.getElementById('tenant-hash').value;
            const source = document.getElementById('widget-source').value;
            const container = document.getElementById('widget-container');
            
            // Clear existing widget
            container.innerHTML = '';
            
            // Create widget script
            const script = document.createElement('script');
            script.id = 'picasso-widget-script';
            
            if (source === 'local') {
                // When viewing from S3, load widget from same S3 bucket
                script.src = '/widget.js';
                log('Loading widget from S3 bucket', 'info');
            } else if (source === 'staging-cdn') {
                script.src = 'https://picassostaging.s3.amazonaws.com/widget.js';
                log('Loading widget from staging S3', 'info');
            } else {
                script.src = 'https://picassocode.s3.amazonaws.com/widget.js';
                log('Loading widget from production S3', 'info');
            }
            
            script.setAttribute('data-tenant', tenantHash);
            script.async = true;
            
            script.onload = () => {
                const loadTime = Date.now() - startTime;
                document.getElementById('load-time').textContent = loadTime;
                log(`Widget loaded successfully in ${loadTime}ms`, 'success');
                widgetLoaded = true;
                updateStatus('widget-status', 'active');
                
                // Check for widget initialization
                setTimeout(() => {
                    if (window.Picasso) {
                        log('Picasso object detected in window', 'success');
                    }
                    checkWidgetFrame();
                }, 1000);
            };
            
            script.onerror = (error) => {
                log(`Failed to load widget: ${error.message || 'Unknown error'}`, 'error');
                updateStatus('widget-status', 'error');
            };
            
            document.body.appendChild(script);
        }
        
        // Reload widget
        function reloadWidget() {
            removeWidget();
            setTimeout(loadWidget, 500);
        }
        
        // Remove widget
        function removeWidget() {
            log('Removing widget...', 'info');
            
            // Remove script
            const script = document.getElementById('picasso-widget-script');
            if (script) script.remove();
            
            // Remove iframe
            const iframe = document.querySelector('iframe[id*="picasso"]');
            if (iframe) iframe.remove();
            
            // Clear container
            document.getElementById('widget-container').innerHTML = `
                <div class="widget-placeholder">
                    <p>Widget removed</p>
                </div>
            `;
            
            widgetLoaded = false;
            updateStatus('widget-status', '');
            log('Widget removed', 'info');
        }
        
        // Check widget frame
        function checkWidgetFrame() {
            const iframe = document.querySelector('iframe[id*="picasso"]');
            if (iframe) {
                log('Widget iframe detected: ' + iframe.id, 'success');
                
                // Try to access iframe content (may be blocked by CORS)
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    log('Iframe accessible - same origin', 'success');
                } catch (e) {
                    log('Iframe loaded but cross-origin (expected behavior)', 'info');
                }
            } else {
                log('Widget iframe not found', 'warning');
            }
        }
        
        // Test health check
        async function testHealthCheck() {
            log('Testing Lambda health check...', 'info');
            const endpoint = document.getElementById('api-endpoint').value;
            let apiUrl = endpoint === 'staging' ? STAGING_API : PRODUCTION_API;
            
            try {
                const response = await fetch(`${apiUrl}/?action=health_check`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                log(`Health check response: ${JSON.stringify(data)}`, 'success');
                updateStatus('lambda-status', 'active');
                apiCallCount++;
                document.getElementById('api-calls').textContent = apiCallCount;
            } catch (error) {
                log(`Health check failed: ${error.message}`, 'error');
                updateStatus('lambda-status', 'error');
            }
        }
        
        // Test configuration
        async function testConfig() {
            log('Testing configuration endpoint...', 'info');
            const tenantHash = document.getElementById('tenant-hash').value;
            const endpoint = document.getElementById('api-endpoint').value;
            let apiUrl = endpoint === 'staging' ? STAGING_API : PRODUCTION_API;
            
            try {
                const response = await fetch(`${apiUrl}/?action=get_config&t=${tenantHash}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                log(`Config loaded: ${data.chat_title || 'Unknown'}`, 'success');
                
                if (data.features?.streaming_enabled) {
                    log('Streaming is ENABLED in config', 'success');
                    updateStatus('streaming-status', 'active');
                } else {
                    log('Streaming is DISABLED in config', 'warning');
                }
                
                apiCallCount++;
                document.getElementById('api-calls').textContent = apiCallCount;
            } catch (error) {
                log(`Config load failed: ${error.message}`, 'error');
            }
        }
        
        // Test session initialization
        async function testInitSession() {
            log('Testing session initialization...', 'info');
            const tenantHash = document.getElementById('tenant-hash').value;
            const endpoint = document.getElementById('api-endpoint').value;
            let apiUrl = endpoint === 'staging' ? STAGING_API : PRODUCTION_API;
            
            try {
                const response = await fetch(`${apiUrl}/?action=init_session&t=${tenantHash}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        tenant_hash: tenantHash
                    })
                });
                
                const data = await response.json();
                sessionId = data.session_id;
                document.getElementById('session-id').value = sessionId;
                log(`Session initialized: ${sessionId}`, 'success');
                
                if (data.state_token) {
                    log('State token received (conversation memory enabled)', 'success');
                }
                
                apiCallCount++;
                document.getElementById('api-calls').textContent = apiCallCount;
            } catch (error) {
                log(`Session init failed: ${error.message}`, 'error');
            }
        }
        
        // Send test message
        async function sendTestMessage() {
            const message = document.getElementById('test-message').value;
            if (!message) return;
            
            log(`Sending message: "${message}"`, 'info');
            const tenantHash = document.getElementById('tenant-hash').value;
            const endpoint = document.getElementById('api-endpoint').value;
            let apiUrl = endpoint === 'staging' ? STAGING_API : PRODUCTION_API;
            
            if (!sessionId) {
                await testInitSession();
            }
            
            try {
                const response = await fetch(`${apiUrl}/?action=chat&t=${tenantHash}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        user_input: message,
                        session_id: sessionId,
                        tenant_hash: tenantHash,
                        conversation_context: {
                            recentMessages: []
                        }
                    })
                });
                
                const data = await response.json();
                log(`Response received: ${data.message?.substring(0, 100)}...`, 'success');
                
                messageCount++;
                document.getElementById('messages-sent').textContent = messageCount;
                apiCallCount++;
                document.getElementById('api-calls').textContent = apiCallCount;
            } catch (error) {
                log(`Message send failed: ${error.message}`, 'error');
            }
        }
        
        // Test JWT generation
        async function testJWT() {
            log('Testing JWT token generation...', 'info');
            const tenantHash = document.getElementById('tenant-hash').value;
            const endpoint = document.getElementById('api-endpoint').value;
            let apiUrl = endpoint === 'staging' ? STAGING_API : PRODUCTION_API;
            
            try {
                const response = await fetch(`${apiUrl}/?action=generate_stream_token&t=${tenantHash}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        tenant_hash: tenantHash,
                        session_id: sessionId || 'test-session'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('JWT token generated successfully', 'success');
                    if (data.token) {
                        log(`Token preview: ${data.token.substring(0, 50)}...`, 'info');
                    }
                } else {
                    log(`JWT generation not available (${response.status})`, 'warning');
                }
                
                apiCallCount++;
                document.getElementById('api-calls').textContent = apiCallCount;
            } catch (error) {
                log(`JWT test failed: ${error.message}`, 'error');
            }
        }
        
        // Run all tests
        async function runAllTests() {
            log('Starting comprehensive test suite...', 'info');
            const testResults = document.getElementById('test-results');
            
            // Update all tests to pending
            testResults.querySelectorAll('li').forEach(li => {
                li.className = 'pending';
                li.textContent = '‚è≥ ' + li.textContent.replace(/^[^A-Za-z]*/, '');
            });
            
            // Run tests sequentially
            const tests = [
                { name: 'Lambda Health Check', fn: testHealthCheck },
                { name: 'Configuration Loading', fn: testConfig },
                { name: 'Session Initialization', fn: testInitSession },
                { name: 'Chat Message Flow', fn: () => sendTestMessage() },
                { name: 'Streaming Response', fn: testStreamingEndpoint },
                { name: 'Error Handling', fn: testErrorHandling },
                { name: 'CORS Headers', fn: testCORS },
                { name: 'Conversation Memory', fn: testConversationMemory }
            ];
            
            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                const li = testResults.children[i];
                
                try {
                    await test.fn();
                    li.className = 'passed';
                    li.textContent = '‚úÖ ' + test.name;
                } catch (error) {
                    li.className = 'failed';
                    li.textContent = '‚ùå ' + test.name;
                    log(`Test failed: ${test.name} - ${error.message}`, 'error');
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log('Test suite completed', 'success');
        }
        
        // Test streaming endpoint
        async function testStreamingEndpoint() {
            log('Testing streaming endpoint...', 'info');
            
            try {
                const response = await fetch(STAGING_STREAMING, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': 'http://localhost:8000'
                    }
                });
                
                if (response.ok) {
                    log('Streaming endpoint accessible', 'success');
                    updateStatus('streaming-status', 'active');
                } else {
                    log('Streaming endpoint returned: ' + response.status, 'warning');
                }
            } catch (error) {
                log(`Streaming endpoint test failed: ${error.message}`, 'error');
            }
        }
        
        // Test error handling
        async function testErrorHandling() {
            log('Testing error handling...', 'info');
            const endpoint = document.getElementById('api-endpoint').value;
            let apiUrl = endpoint === 'staging' ? STAGING_API : PRODUCTION_API;
            
            try {
                // Test with invalid action
                const response = await fetch(`${apiUrl}/?action=invalid_action`, {
                    method: 'GET'
                });
                
                const data = await response.json();
                if (response.status === 404 && data.error) {
                    log('Error handling working correctly', 'success');
                } else {
                    log('Unexpected error response', 'warning');
                }
            } catch (error) {
                log(`Error handling test failed: ${error.message}`, 'error');
            }
        }
        
        // Test CORS
        async function testCORS() {
            log('Testing CORS headers...', 'info');
            const endpoint = document.getElementById('api-endpoint').value;
            let apiUrl = endpoint === 'staging' ? STAGING_API : PRODUCTION_API;
            
            try {
                const response = await fetch(`${apiUrl}/?action=health_check`, {
                    method: 'GET',
                    headers: {
                        'Origin': 'http://localhost:8000'
                    }
                });
                
                const corsHeaders = {
                    'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                    'access-control-allow-methods': response.headers.get('access-control-allow-methods'),
                    'access-control-allow-headers': response.headers.get('access-control-allow-headers')
                };
                
                if (corsHeaders['access-control-allow-origin']) {
                    log('CORS headers present: ' + JSON.stringify(corsHeaders), 'success');
                } else {
                    log('CORS headers missing', 'error');
                }
            } catch (error) {
                log(`CORS test failed: ${error.message}`, 'error');
            }
        }
        
        // Test conversation memory
        async function testConversationMemory() {
            log('Testing conversation memory...', 'info');
            const tenantHash = document.getElementById('tenant-hash').value;
            const endpoint = document.getElementById('api-endpoint').value;
            let apiUrl = endpoint === 'staging' ? STAGING_API : PRODUCTION_API;
            
            try {
                // Send first message
                const response1 = await fetch(`${apiUrl}/?action=chat&t=${tenantHash}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_input: 'My name is TestUser',
                        session_id: sessionId,
                        tenant_hash: tenantHash,
                        conversation_context: {
                            recentMessages: []
                        }
                    })
                });
                
                // Send second message with context
                const response2 = await fetch(`${apiUrl}/?action=chat&t=${tenantHash}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_input: 'What is my name?',
                        session_id: sessionId,
                        tenant_hash: tenantHash,
                        conversation_context: {
                            recentMessages: [
                                { role: 'user', content: 'My name is TestUser' },
                                { role: 'assistant', content: 'Nice to meet you, TestUser!' }
                            ]
                        }
                    })
                });
                
                if (response2.ok) {
                    log('Conversation memory test completed', 'success');
                }
            } catch (error) {
                log(`Conversation memory test failed: ${error.message}`, 'error');
            }
        }
        
        // Generate new session
        function generateNewSession() {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            document.getElementById('session-id').value = sessionId;
            log('New session ID generated: ' + sessionId, 'info');
        }
        
        // Export test results
        function exportTestResults() {
            const results = {
                timestamp: new Date().toISOString(),
                environment: document.getElementById('api-endpoint').value,
                tenant: document.getElementById('tenant-hash').value,
                metrics: {
                    loadTime: document.getElementById('load-time').textContent,
                    apiCalls: apiCallCount,
                    messages: messageCount,
                    errors: errorCount
                },
                console: Array.from(document.querySelectorAll('.console-line')).map(line => line.textContent)
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `picasso-test-results-${Date.now()}.json`;
            a.click();
            
            log('Test results exported', 'success');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Test page initialized', 'success');
            updateStatus('server-status', 'active');
            
            // Auto-load widget on page load
            log('Auto-loading widget...', 'info');
            loadWidget();
            
            // Check Lambda connectivity after widget loads
            setTimeout(() => {
                testHealthCheck();
            }, 2000);
        });
        
        // Monitor for widget messages
        window.addEventListener('message', (event) => {
            if (event.data && typeof event.data === 'string' && event.data.includes('picasso')) {
                log(`Widget message received: ${event.data.substring(0, 100)}...`, 'info');
            }
        });
    </script>
</body>
</html>