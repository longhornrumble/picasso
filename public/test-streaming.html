<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Picasso Streaming Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 4px;
            border: 1px solid #3b82f6;
        }
        .error {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }
        .success {
            background: #f0fdf4;
            border-color: #22c55e;
            color: #16a34a;
        }
        pre {
            background: #1e293b;
            color: #f1f5f9;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Picasso Streaming Test</h1>
        
        <div class="status" id="status">
            Ready to test streaming...
        </div>

        <div style="margin: 20px 0;">
            <button onclick="enableStreaming()">1. Enable Streaming</button>
            <button onclick="checkStatus()">2. Check Status</button>
            <button onclick="simulateStream()">3. Simulate Stream</button>
            <button onclick="resetWidget()">4. Reset Widget</button>
        </div>

        <h3>Console Output:</h3>
        <pre id="console"></pre>

        <h3>Instructions:</h3>
        <ol>
            <li>Click "Enable Streaming" to force enable streaming</li>
            <li>Click "Check Status" to verify streaming is enabled</li>
            <li>Open the widget and send a message</li>
            <li>Watch the console for streaming activity</li>
        </ol>
    </div>

    <!-- Picasso Widget -->
    <script src="widget.js" data-tenant="my87674d777bf9"></script>

    <script>
        const log = (msg, type = 'info') => {
            const console = document.getElementById('console');
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#22c55e' : '#3b82f6';
            console.innerHTML += `<span style="color: ${color}">[${timestamp}] ${msg}</span>\n`;
            console.scrollTop = console.scrollHeight;
            
            // Also update status
            const status = document.getElementById('status');
            status.className = 'status ' + type;
            status.textContent = msg;
        };

        function enableStreaming() {
            if (window.enablePicassoStreaming) {
                window.enablePicassoStreaming();
                log('âœ… Streaming enabled! Refresh to apply changes.', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                log('âŒ Streaming control not available yet. Wait for widget to load.', 'error');
            }
        }

        function checkStatus() {
            // Wait for chat context to be available
            setTimeout(() => {
                const iframe = document.querySelector('iframe[id*="picasso"]');
                if (iframe && iframe.contentWindow) {
                    // Try to access the chat context
                    iframe.contentWindow.postMessage({
                        type: 'PICASSO_DEBUG_REQUEST'
                    }, '*');
                }
                
                // Check if we have access to debug info
                if (window.picassoConfig) {
                    const config = window.picassoConfig;
                    log(`Config loaded: ${config.chat_title || 'Unknown'}`, 'success');
                }
                
                // Check streaming flags
                if (window.testStreamingFeatureFlag) {
                    const result = window.testStreamingFeatureFlag();
                    log(`Streaming status: Legacy=${result.legacy}, JWT=${result.jwt}`, result.legacy ? 'success' : 'error');
                } else {
                    log('Debug commands not available yet', 'error');
                }
            }, 500);
        }

        function simulateStream() {
            log('ðŸ”„ Simulating streaming response...', 'info');
            
            // Create a mock streaming message
            const mockMessage = "This is a simulated streaming response that will appear character by character to test the streaming functionality!";
            let index = 0;
            
            const streamInterval = setInterval(() => {
                if (index < mockMessage.length) {
                    const chunk = mockMessage.slice(index, index + 5);
                    log(`Chunk: "${chunk}"`, 'info');
                    index += 5;
                } else {
                    clearInterval(streamInterval);
                    log('âœ… Stream simulation complete!', 'success');
                }
            }, 100);
        }

        function resetWidget() {
            if (window.PicassoWidget) {
                window.PicassoWidget.close();
                log('Widget reset', 'info');
                setTimeout(() => location.reload(), 500);
            }
        }

        // Listen for messages from iframe
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'PICASSO_DEBUG_RESPONSE') {
                log(`Debug info: ${JSON.stringify(event.data.debug, null, 2)}`, 'info');
            }
        });

        // Auto-check status after load
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('Widget loaded. Checking initial status...', 'info');
                checkStatus();
            }, 2000);
        });
    </script>
</body>
</html>