<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Picasso Widget Test Page</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      line-height: 1.6;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }

    h1 {
      color: #2d3748;
      margin-bottom: 1rem;
    }

    .test-section {
      margin-bottom: 2rem;
      padding: 1rem;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #f7fafc;
    }

    .test-section h3 {
      margin-top: 0;
      color: #4a5568;
    }

    button {
      background: #4299e1;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      margin: 0.25rem;
      font-size: 14px;
      transition: all 0.2s;
    }

    button:hover {
      background: #3182ce;
      transform: translateY(-1px);
    }

    button:disabled {
      background: #a0aec0;
      cursor: not-allowed;
      transform: none;
    }

    .code {
      background: #2d3748;
      color: #e2e8f0;
      padding: 1rem;
      border-radius: 6px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      overflow-x: auto;
      margin: 1rem 0;
    }

    .status {
      padding: 0.5rem;
      border-radius: 4px;
      margin: 0.5rem 0;
      font-weight: 500;
    }

    .status.success {
      background: #c6f6d5;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    .status.error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #feb2b2;
    }

    .status.info {
      background: #bee3f8;
      color: #2c5282;
      border: 1px solid #90cdf4;
    }

    .tenant-selector {
      display: flex;
      gap: 0.5rem;
      margin: 1rem 0;
      flex-wrap: wrap;
    }

    .logs {
      background: #1a202c;
      color: #e2e8f0;
      padding: 1rem;
      border-radius: 6px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .widget-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .info-card {
      padding: 1rem;
      background: white;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .info-card h4 {
      margin: 0 0 0.5rem 0;
      color: #4a5568;
      font-size: 14px;
      font-weight: 600;
    }

    .info-value {
      font-family: monospace;
      font-size: 13px;
      color: #2d3748;
      word-break: break-all;
    }

    .test-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
      margin: 1rem 0;
    }

    .test-controls label {
      font-weight: 500;
      color: #4a5568;
    }

    .test-controls select,
    .test-controls input {
      padding: 0.5rem;
      border: 1px solid #d2d6dc;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé® Picasso Widget Test Page</h1>
    <p>Test the Picasso chatbot widget in different configurations and environments.</p>

    <!-- Widget Status -->
    <div class="test-section">
      <h3>üìä Widget Status</h3>
      <div id="status" class="status info">Loading...</div>
      
      <div class="widget-info">
        <div class="info-card">
          <h4>Tenant ID</h4>
          <div id="tenant-id" class="info-value">-</div>
        </div>
        <div class="info-card">
          <h4>Version</h4>
          <div id="version" class="info-value">-</div>
        </div>
        <div class="info-card">
          <h4>Load Time</h4>
          <div id="load-time" class="info-value">-</div>
        </div>
        <div class="info-card">
          <h4>Environment</h4>
          <div id="environment" class="info-value">-</div>
        </div>
      </div>
    </div>

    <!-- Tenant Testing -->
    <div class="test-section">
      <h3>üè¢ Tenant Testing</h3>
      <p>Test different tenant configurations:</p>
      
      <div class="test-controls">
        <button onclick="loadTenant('fo85e6a06dcdf4')">Foster Village</button>
        <button onclick="loadTenant('nac070e6881bbc')">National Angels</button>
        <button onclick="loadTenant('demo')">Demo Tenant</button>
        <button onclick="loadTenant('invalid')">Invalid Tenant</button>
        <button onclick="openFullPage()">Open Full-Page</button>
      </div>

      <div class="test-controls">
        <label for="custom-tenant">Custom Tenant:</label>
        <input type="text" id="custom-tenant" placeholder="Enter tenant hash">
        <button onclick="loadCustomTenant()">Load</button>
      </div>
    </div>

    <!-- Widget Controls -->
    <div class="test-section">
      <h3>üéõÔ∏è Widget Controls</h3>
      
      <div class="test-controls">
        <button onclick="toggleWidget()">Toggle Widget</button>
        <button onclick="destroyWidget()">Destroy Widget</button>
        <button onclick="reloadWidget()">Reload Widget</button>
        <button onclick="clearLogs()">Clear Logs</button>
      </div>

      <div class="test-controls">
        <label for="environment-select">Environment:</label>
        <select id="environment-select" onchange="changeEnvironment()">
          <option value="local">Local Development</option>
          <option value="staging">Staging</option>
          <option value="production" selected>Production</option>
        </select>
      </div>
    </div>

    <!-- Performance Testing -->
    <div class="test-section">
      <h3>‚ö° Performance Testing</h3>
      
      <div class="test-controls">
        <button onclick="measureLoadTime()">Measure Load Time</button>
        <button onclick="stressTest()">Stress Test (10x)</button>
        <button onclick="memoryTest()">Memory Usage</button>
      </div>

      <div id="performance-results"></div>
    </div>

    <!-- Integration Code -->
    <div class="test-section">
      <h3>üìã Integration Code</h3>
      <p>Copy this code to embed the widget on your site:</p>
      
      <!-- Integration code -->
      <div class="code" id="integration-code">
&lt;!-- Option 1: Embedded Widget --&gt;
&lt;script src="https://chat.myrecruiter.ai/widget.js" data-tenant="fo85e6a06dcdf4"&gt;&lt;/script&gt;

&lt;!-- Option 2: Full-Page Chat --&gt;
https://chat.myrecruiter.ai/fullpage.html?tenant=fo85e6a06dcdf4

&lt;!-- Option 3: Separate CSS + JS for custom styling --&gt;
&lt;link rel="stylesheet" href="https://chat.myrecruiter.ai/widget.css"&gt;
&lt;script src="https://chat.myrecruiter.ai/widget.js" data-tenant="fo85e6a06dcdf4"&gt;&lt;/script&gt;
      </div>
      
      <button onclick="copyIntegrationCode()">Copy Code</button>
    </div>

    <!-- Console Logs -->
    <div class="test-section">
      <h3>üìù Console Logs</h3>
      <div id="logs" class="logs">Waiting for widget events...</div>
    </div>
  </div>

  <script>
    // Test page state
    let currentTenant = 'fo85e6a06dcdf4';
    let currentEnvironment = 'production';
    let loadStartTime = Date.now();
    
    // Environment URLs
    const environments = {
      local: 'http://localhost:3000/widget.js',
      staging: 'https://staging-chat.myrecruiter.ai/widget.js',
      production: 'https://chat.myrecruiter.ai/widget.js'
    };

    // Logging
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logElement = document.getElementById('logs');
      const entry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
      logElement.textContent += entry;
      logElement.scrollTop = logElement.scrollHeight;
      
      // Also log to browser console
      console.log(`[Picasso Test] ${message}`);
    }

    // Intercept console messages
    const originalLog = console.log;
    const originalWarn = console.warn;
    const originalError = console.error;

    console.log = function(...args) {
      if (args[0] && args[0].includes && args[0].includes('Picasso')) {
        log(args.join(' '), 'info');
      }
      originalLog.apply(console, args);
    };

    console.warn = function(...args) {
      if (args[0] && args[0].includes && args[0].includes('Picasso')) {
        log(args.join(' '), 'warn');
      }
      originalWarn.apply(console, args);
    };

    console.error = function(...args) {
      if (args[0] && args[0].includes && args[0].includes('Picasso')) {
        log(args.join(' '), 'error');
      }
      originalError.apply(console, args);
    };

    // Update status
    function updateStatus(message, type = 'info') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }

    // Update info cards
    function updateInfo() {
      document.getElementById('tenant-id').textContent = currentTenant;
      document.getElementById('version').textContent = window.Picasso?.version || 'Unknown';
      document.getElementById('load-time').textContent = `${Date.now() - loadStartTime}ms`;
      document.getElementById('environment').textContent = currentEnvironment;
    }

    // Load widget for specific tenant
    function loadTenant(tenantId) {
      log(`Loading tenant: ${tenantId}`);
      currentTenant = tenantId;
      
      // Update integration code
      const integrationCode = `&lt;script src="${environments[currentEnvironment]}" data-tenant="${tenantId}"&gt;&lt;/script&gt;`;
      document.getElementById('integration-code').innerHTML = integrationCode;
      
      // Reload widget
      reloadWidget();
      updateInfo();
    }

    // Open full-page mode
    function openFullPage() {
      const fullpageUrl = `${window.location.origin}/fullpage.html?tenant=${currentTenant}`;
      window.open(fullpageUrl, '_blank');
      log(`Opened full-page mode: ${fullpageUrl}`);
    }

    // Change environment
    function changeEnvironment() {
      const select = document.getElementById('environment-select');
      currentEnvironment = select.value;
      log(`Switched to ${currentEnvironment} environment`);
      
      // Update integration code
      loadTenant(currentTenant);
    }

    // Widget controls
    function toggleWidget() {
      if (window.__picassoWidget) {
        // Try to toggle if widget has toggle method
        if (window.__picassoWidget.toggle) {
          window.__picassoWidget.toggle();
        } else {
          log('Widget toggle method not available', 'warn');
        }
      } else {
        log('No widget instance found', 'error');
      }
    }

    function destroyWidget() {
      if (window.Picasso && window.Picasso.destroy) {
        window.Picasso.destroy();
        updateStatus('Widget destroyed', 'info');
        log('Widget destroyed');
      } else {
        log('Widget destroy method not available', 'warn');
      }
      updateInfo();
    }

    function reloadWidget() {
      log('Reloading widget...');
      loadStartTime = Date.now();
      
      // Destroy existing widget
      destroyWidget();
      
      // Remove existing script
      const existingScript = document.querySelector('script[src*="widget.js"]');
      if (existingScript) {
        existingScript.remove();
      }
      
      // Clear global state
      delete window.__picassoWidgetMounted;
      delete window.__picassoWidget;
      delete window.Picasso;
      delete window.PicassoConfig;
      
      // Wait a moment then load new script
      setTimeout(() => {
        const script = document.createElement('script');
        script.src = environments[currentEnvironment];
        script.setAttribute('data-tenant', currentTenant);
        
        script.onload = () => {
          updateStatus('Widget loaded successfully', 'success');
          log('Widget script loaded');
          updateInfo();
        };
        
        script.onerror = () => {
          updateStatus('Failed to load widget', 'error');
          log('Failed to load widget script', 'error');
        };
        
        document.head.appendChild(script);
      }, 100);
    }

    // Performance testing
    function measureLoadTime() {
      const start = performance.now();
      reloadWidget();
      
      const checkLoaded = setInterval(() => {
        if (window.__picassoWidgetMounted) {
          const loadTime = performance.now() - start;
          log(`Widget load time: ${loadTime.toFixed(2)}ms`);
          clearInterval(checkLoaded);
          
          document.getElementById('performance-results').innerHTML = `
            <div class="status success">Load time: ${loadTime.toFixed(2)}ms</div>
          `;
        }
      }, 50);
      
      // Timeout after 10 seconds
      setTimeout(() => {
        clearInterval(checkLoaded);
        if (!window.__picassoWidgetMounted) {
          log('Widget load timeout (10s)', 'error');
          document.getElementById('performance-results').innerHTML = `
            <div class="status error">Load timeout after 10 seconds</div>
          `;
        }
      }, 10000);
    }

    function stressTest() {
      log('Starting stress test (10 rapid loads)');
      let completed = 0;
      const times = [];
      
      function testLoad(index) {
        const start = performance.now();
        
        // Destroy and reload
        destroyWidget();
        setTimeout(() => {
          reloadWidget();
          
          const checkLoaded = setInterval(() => {
            if (window.__picassoWidgetMounted) {
              const time = performance.now() - start;
              times.push(time);
              completed++;
              
              log(`Load ${index + 1}/10: ${time.toFixed(2)}ms`);
              clearInterval(checkLoaded);
              
              if (completed === 10) {
                const avgTime = times.reduce((a, b) => a + b) / times.length;
                const maxTime = Math.max(...times);
                const minTime = Math.min(...times);
                
                log(`Stress test complete. Avg: ${avgTime.toFixed(2)}ms, Min: ${minTime.toFixed(2)}ms, Max: ${maxTime.toFixed(2)}ms`);
                
                document.getElementById('performance-results').innerHTML = `
                  <div class="status success">
                    Stress test complete<br>
                    Average: ${avgTime.toFixed(2)}ms<br>
                    Range: ${minTime.toFixed(2)}ms - ${maxTime.toFixed(2)}ms
                  </div>
                `;
              } else if (index < 9) {
                setTimeout(() => testLoad(index + 1), 500);
              }
            }
          }, 50);
        }, 100);
      }
      
      testLoad(0);
    }

    function memoryTest() {
      if (performance.memory) {
        const memory = performance.memory;
        const used = (memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
        const total = (memory.totalJSHeapSize / 1024 / 1024).toFixed(2);
        const limit = (memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2);
        
        log(`Memory usage: ${used}MB / ${total}MB (limit: ${limit}MB)`);
        
        document.getElementById('performance-results').innerHTML = `
          <div class="status info">
            Memory Usage<br>
            Used: ${used}MB<br>
            Total: ${total}MB<br>
            Limit: ${limit}MB
          </div>
        `;
      } else {
        log('Memory API not available', 'warn');
        document.getElementById('performance-results').innerHTML = `
          <div class="status error">Memory API not available in this browser</div>
        `;
      }
    }

    // Utility functions
    function clearLogs() {
      document.getElementById('logs').textContent = '';
      log('Logs cleared');
    }

    function copyIntegrationCode() {
      const code = document.getElementById('integration-code').textContent;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(code).then(() => {
          log('Integration code copied to clipboard');
        });
      } else {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = code;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        log('Integration code copied to clipboard (fallback method)');
      }
    }

    // Listen for Picasso events
    window.addEventListener('picasso:mounted', (event) => {
      log(`Widget mounted for tenant: ${event.detail?.tenantId}`);
      updateStatus('Widget mounted successfully', 'success');
      updateInfo();
    });

    window.addEventListener('picasso:error', (event) => {
      log(`Widget error: ${event.detail?.error}`, 'error');
      updateStatus('Widget error occurred', 'error');
    });

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      log('Test page initialized');
      updateStatus('Ready for testing', 'info');
      updateInfo();
      
      // Auto-load widget after 1 second
      setTimeout(() => {
        reloadWidget();
      }, 1000);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
          case 'r':
            e.preventDefault();
            reloadWidget();
            break;
          case 'd':
            e.preventDefault();
            destroyWidget();
            break;
          case 'l':
            e.preventDefault();
            clearLogs();
            break;
        }
      }
    });
  </script>

  <!-- Load widget automatically -->
  <script>
    // This will be replaced by the reloadWidget function
  </script>
</body>
</html>