AWSTemplateFormatVersion: '2010-09-09'
Description: 'Emergency Security Monitoring Dashboard - Real-time Cross-Tenant Protection Monitoring'

Parameters:
  Environment:
    Type: String
    AllowedValues: [staging, production]
    Default: staging
    Description: Environment for monitoring dashboard

Resources:
  # CloudWatch Dashboard for Security Monitoring
  SecurityMonitoringDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub "${Environment}-Emergency-Security-Monitor"
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/ApplicationELB", "HTTPCode_Target_4XX_Count", "LoadBalancer", "app/picasso-alb" ],
                  [ ".", "HTTPCode_Target_5XX_Count", ".", "." ],
                  [ ".", "RequestCount", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "üö® EMERGENCY: Cross-Tenant Access Attempts",
                "period": 60,
                "stat": "Sum",
                "annotations": {
                  "horizontal": [
                    {
                      "label": "Critical Threshold",
                      "value": 10,
                      "fill": "above"
                    }
                  ]
                },
                "yAxis": {
                  "left": {
                    "min": 0
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "Security/CrossTenant", "UnauthorizedAccess" ],
                  [ "AWS/Lambda", "Errors", "FunctionName", "${Environment}-Master-Function" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "üîí Security Breach Attempts",
                "period": 60,
                "stat": "Sum",
                "annotations": {
                  "horizontal": [
                    {
                      "label": "Zero Tolerance",
                      "value": 0,
                      "fill": "above"
                    }
                  ]
                }
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/WAFv2", "BlockedRequests", "WebACL", "${Environment}-emergency-waf", "Region", "${AWS::Region}" ],
                  [ ".", "AllowedRequests", ".", ".", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "üõ°Ô∏è WAF Protection Status",
                "period": 300,
                "stat": "Sum"
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 6,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/ApiGateway", "4XXError", "ApiName", "${Environment}-picasso-api" ],
                  [ ".", "5XXError", ".", "." ],
                  [ ".", "Count", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "üì° API Gateway Security",
                "period": 300,
                "stat": "Sum"
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 6,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/Lambda", "Duration", "FunctionName", "${Environment}-Master-Function" ],
                  [ ".", "Invocations", ".", "." ],
                  [ ".", "Throttles", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "‚ö° Function Performance",
                "period": 300,
                "stat": "Average"
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 12,
              "width": 24,
              "height": 6,
              "properties": {
                "query": "SOURCE '/aws/lambda/${Environment}-Master-Function'\n| fields @timestamp, @message\n| filter @message like /cross.*tenant/ or @message like /unauthorized.*access/ or @message like /security.*violation/\n| sort @timestamp desc\n| limit 100",
                "region": "${AWS::Region}",
                "title": "üö® CRITICAL: Security Violation Logs",
                "view": "table"
              }
            },
            {
              "type": "text",
              "x": 0,
              "y": 18,
              "width": 24,
              "height": 3,
              "properties": {
                "markdown": "# üö® EMERGENCY SECURITY STATUS\\n\\n**Cross-Tenant Vulnerability Protection:** ACTIVE\\n\\n**Network Isolation:** Deployed\\n\\n**Monitoring:** Real-time\\n\\n---\\n\\n## üî• IMMEDIATE ACTIONS ON ALERTS:\\n\\n1. **Any 4XX/5XX spikes:** Investigate blocked requests immediately\\n2. **WAF blocks:** Review and validate blocked patterns\\n3. **Security violations in logs:** Escalate to security team\\n4. **Function errors:** Check for legitimate traffic being blocked\\n\\n---\\n\\n**Emergency Contacts:** security-team@myrecruiter.ai | Tech Lead SMS"
              }
            }
          ]
        }

  # Custom CloudWatch Metrics for Real-time Monitoring
  CrossTenantAccessMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-Master-Function"
      FilterPattern: "[timestamp, requestId, level=\"ERROR\", message=\"*cross*tenant*\" || message=\"*t=my87674d777bf9*\"]"
      MetricTransformations:
        - MetricNamespace: "Security/Emergency"
          MetricName: "CrossTenantAttempts"
          MetricValue: "1"
          DefaultValue: 0

  SecurityViolationMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-Master-Function"
      FilterPattern: "[timestamp, requestId, level, message=\"*security*violation*\" || message=\"*unauthorized*access*\" || message=\"*tenant*isolation*breach*\"]"
      MetricTransformations:
        - MetricNamespace: "Security/Emergency"
          MetricName: "SecurityViolations"
          MetricValue: "1"
          DefaultValue: 0

  # Real-time Alarms for Immediate Response
  CriticalSecurityBreachAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${Environment}-CRITICAL-Security-Breach"
      AlarmDescription: "CRITICAL: Security breach detected - immediate escalation required"
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      MetricName: "SecurityViolations"
      Namespace: "Security/Emergency"
      Period: 60
      Statistic: Sum
      Threshold: 0
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref CriticalSecurityTopic

  CrossTenantAccessAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${Environment}-Cross-Tenant-Access-Attempt"
      AlarmDescription: "Cross-tenant access attempt detected"
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      MetricName: "CrossTenantAttempts"
      Namespace: "Security/Emergency"
      Period: 60
      Statistic: Sum
      Threshold: 0
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref SecurityNotificationTopic

  # SNS Topics for Immediate Alerts
  CriticalSecurityTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "${Environment}-critical-security-alerts"
      DisplayName: "CRITICAL Security Alerts - Immediate Action Required"
      
  SecurityNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "${Environment}-security-notifications"
      DisplayName: "Security Monitoring Notifications"

  # Lambda function for real-time security analysis
  SecurityAnalysisFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${Environment}-security-analysis"
      Runtime: python3.9
      Handler: index.lambda_handler
      Code:
        ZipFile: |
          import json
          import boto3
          import base64
          import gzip
          from datetime import datetime
          
          def lambda_handler(event, context):
              """
              Real-time security log analysis for cross-tenant access detection
              """
              
              # Decode CloudWatch Logs data
              cw_data = event['awslogs']['data']
              compressed_payload = base64.b64decode(cw_data)
              uncompressed_payload = gzip.decompress(compressed_payload)
              log_data = json.loads(uncompressed_payload)
              
              security_events = []
              
              for log_event in log_data['logEvents']:
                  message = log_event['message']
                  timestamp = log_event['timestamp']
                  
                  # Check for cross-tenant access patterns
                  if any(pattern in message.lower() for pattern in [
                      'cross-tenant', 't=my87674d777bf9', 'unauthorized access',
                      'tenant isolation breach', 'security violation'
                  ]):
                      security_events.append({
                          'timestamp': datetime.fromtimestamp(timestamp/1000).isoformat(),
                          'message': message,
                          'severity': 'CRITICAL' if 'my87674d777bf9' in message else 'HIGH',
                          'log_group': log_data['logGroup'],
                          'log_stream': log_data['logStream']
                      })
              
              if security_events:
                  # Publish to SNS for immediate alert
                  sns = boto3.client('sns')
                  
                  alert_message = {
                      'alert_type': 'SECURITY_BREACH',
                      'environment': context.function_name.split('-')[0],
                      'event_count': len(security_events),
                      'events': security_events,
                      'timestamp': datetime.utcnow().isoformat(),
                      'action_required': 'IMMEDIATE INVESTIGATION'
                  }
                  
                  # Determine topic based on severity
                  topic_arn = f"arn:aws:sns:{context.invoked_function_arn.split(':')[3]}:{context.invoked_function_arn.split(':')[4]}:{context.function_name.split('-')[0]}-critical-security-alerts"
                  
                  sns.publish(
                      TopicArn=topic_arn,
                      Subject=f"üö® CRITICAL: Security Breach Detected - {context.function_name.split('-')[0]}",
                      Message=json.dumps(alert_message, indent=2)
                  )
              
              return {
                  'statusCode': 200,
                  'body': json.dumps({
                      'processed_events': len(log_data['logEvents']),
                      'security_events': len(security_events)
                  })
              }
      
      Role: !GetAtt SecurityAnalysisRole.Arn
      Timeout: 60
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment

  SecurityAnalysisRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SecurityAnalysisPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource: 
                  - !Ref CriticalSecurityTopic
                  - !Ref SecurityNotificationTopic

  # Subscription filter to trigger security analysis
  SecurityLogSubscription:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      LogGroupName: !Sub "/aws/lambda/${Environment}-Master-Function"
      FilterPattern: "[timestamp, requestId, level, message=\"*cross*tenant*\" || message=\"*security*\" || message=\"*unauthorized*\"]"
      DestinationArn: !GetAtt SecurityAnalysisFunction.Arn

  SecurityLogPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt SecurityAnalysisFunction.Arn
      Action: lambda:InvokeFunction
      Principal: logs.amazonaws.com
      SourceArn: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${Environment}-Master-Function:*"

Outputs:
  DashboardURL:
    Description: "Emergency Security Monitoring Dashboard URL"
    Value: !Sub "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${Environment}-Emergency-Security-Monitor"
    Export:
      Name: !Sub "${Environment}-security-dashboard-url"

  CriticalAlertsTopicArn:
    Description: "Critical security alerts SNS topic"
    Value: !Ref CriticalSecurityTopic
    Export:
      Name: !Sub "${Environment}-critical-alerts-topic"

  SecurityAnalysisFunctionArn:
    Description: "Real-time security analysis function"
    Value: !GetAtt SecurityAnalysisFunction.Arn
    Export:
      Name: !Sub "${Environment}-security-analysis-function"