<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual-Path Architecture Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        button.warning {
            background: #ffc107;
            color: #333;
        }
        button.warning:hover {
            background: #e0a800;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .status.http {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .status.streaming {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        .status.error {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
        .status.success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .metric {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        #console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 2px solid transparent;
        }
        .log-entry.info {
            border-left-color: #2196f3;
        }
        .log-entry.success {
            border-left-color: #4caf50;
            color: #4caf50;
        }
        .log-entry.warning {
            border-left-color: #ff9800;
            color: #ff9800;
        }
        .log-entry.error {
            border-left-color: #f44336;
            color: #f44336;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }
        .badge.http {
            background: #2196f3;
            color: white;
        }
        .badge.streaming {
            background: #9c27b0;
            color: white;
        }
    </style>
</head>
<body>
    <h1>ðŸš€ Dual-Path Architecture Test Suite</h1>
    
    <div class="test-section">
        <h2>Current Configuration</h2>
        <div id="current-status" class="status">
            Loading configuration...
        </div>
    </div>

    <div class="test-section">
        <h2>Widget Controls</h2>
        <div class="controls">
            <button onclick="toggleWidget()">Toggle Widget</button>
            <button onclick="openWidget()" class="success">Open Widget</button>
            <button onclick="closeWidget()" class="danger">Close Widget</button>
            <button onclick="reloadWidget()" class="warning">Reload Widget</button>
        </div>
        
        <h3>Path Testing</h3>
        <div class="controls">
            <button onclick="testHTTPPath()">Test HTTP Path</button>
            <button onclick="testStreamingPath()">Test Streaming Path</button>
            <button onclick="togglePath()" class="warning">Toggle Path (Requires Reload)</button>
        </div>
    </div>

    <div class="test-section">
        <h2>Performance Metrics</h2>
        <div class="metrics">
            <div class="metric">
                <div class="metric-value" id="load-time">-</div>
                <div class="metric-label">Widget Load Time</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="provider-decision">-</div>
                <div class="metric-label">Provider Decision Time</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="message-response">-</div>
                <div class="metric-label">Last Message Response</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="active-provider">-</div>
                <div class="metric-label">Active Provider</div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Console Output</h2>
        <div id="console-output"></div>
    </div>

    <!-- Load the widget -->
    <script src="http://localhost:8000/widget.js" 
            data-tenant="my87674d777bf9"
            data-debug="true"></script>

    <script>
        // Performance tracking
        const metrics = {
            widgetLoadStart: Date.now(),
            widgetLoadEnd: null,
            providerDecisionTime: null,
            lastMessageTime: null,
            currentProvider: 'unknown'
        };

        // Console capture
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        const consoleOutput = document.getElementById('console-output');
        
        function addLogEntry(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            consoleOutput.appendChild(entry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // Override console methods to capture logs
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
            ).join(' ');
            
            // Detect provider decisions
            if (message.includes('CHAT PROVIDER INITIALIZED')) {
                metrics.providerDecisionTime = Date.now() - metrics.widgetLoadStart;
                document.getElementById('provider-decision').textContent = `${metrics.providerDecisionTime}ms`;
                
                if (message.includes('HTTP')) {
                    metrics.currentProvider = 'HTTP';
                    document.getElementById('active-provider').innerHTML = '<span class="badge http">HTTP</span>';
                    addLogEntry('âœ… HTTP Provider Selected', 'success');
                } else if (message.includes('STREAMING')) {
                    metrics.currentProvider = 'STREAMING';
                    document.getElementById('active-provider').innerHTML = '<span class="badge streaming">STREAMING</span>';
                    addLogEntry('âœ… Streaming Provider Selected', 'success');
                }
            }
            
            if (message.includes('FORCE OVERRIDE ACTIVE')) {
                addLogEntry(message, 'warning');
            } else if (message.includes('ðŸš€')) {
                addLogEntry(message, 'success');
            } else {
                addLogEntry(message, 'info');
            }
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLogEntry(args.join(' '), 'warning');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLogEntry(args.join(' '), 'error');
        };

        // Widget control functions
        function toggleWidget() {
            if (window.PicassoWidget) {
                window.PicassoWidget.toggle();
                addLogEntry('Widget toggled', 'info');
            }
        }

        function openWidget() {
            if (window.PicassoWidget) {
                window.PicassoWidget.open();
                addLogEntry('Widget opened', 'success');
            }
        }

        function closeWidget() {
            if (window.PicassoWidget) {
                window.PicassoWidget.close();
                addLogEntry('Widget closed', 'info');
            }
        }

        function reloadWidget() {
            addLogEntry('Reloading widget...', 'warning');
            location.reload();
        }

        // Path testing
        function testHTTPPath() {
            localStorage.setItem('PICASSO_STREAMING_MODE', 'false');
            addLogEntry('Set to HTTP mode - reload to apply', 'warning');
            updateStatus('HTTP mode will be active after reload', 'http');
        }

        function testStreamingPath() {
            localStorage.setItem('PICASSO_STREAMING_MODE', 'true');
            addLogEntry('Set to Streaming mode - reload to apply', 'warning');
            updateStatus('Streaming mode will be active after reload', 'streaming');
        }

        function togglePath() {
            const current = localStorage.getItem('PICASSO_STREAMING_MODE');
            const newMode = current === 'true' ? 'false' : 'true';
            localStorage.setItem('PICASSO_STREAMING_MODE', newMode);
            addLogEntry(`Toggled to ${newMode === 'true' ? 'Streaming' : 'HTTP'} mode - reload to apply`, 'warning');
            setTimeout(reloadWidget, 1000);
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('current-status');
            status.className = `status ${type}`;
            status.innerHTML = message;
        }

        // Monitor widget load
        window.addEventListener('load', () => {
            metrics.widgetLoadEnd = Date.now();
            const loadTime = metrics.widgetLoadEnd - metrics.widgetLoadStart;
            document.getElementById('load-time').textContent = `${loadTime}ms`;
            
            if (window.PicassoWidget) {
                addLogEntry(`âœ… Widget loaded in ${loadTime}ms`, 'success');
                
                // Check streaming config
                if (window.getStreamingConfig) {
                    const config = window.getStreamingConfig();
                    updateStatus(`
                        <strong>Streaming Configuration:</strong><br>
                        Main Control: ${config.mainControl ? 'ENABLED' : 'DISABLED'}<br>
                        Runtime Override: ${config.runtimeOverride}<br>
                        Current Value: ${config.currentValue ? 'STREAMING' : 'HTTP'}
                        ${config.currentValue ? '<span class="badge streaming">STREAMING</span>' : '<span class="badge http">HTTP</span>'}
                    `, config.currentValue ? 'streaming' : 'http');
                }
            } else {
                addLogEntry('âŒ Widget failed to load', 'error');
                updateStatus('Widget failed to load', 'error');
            }
        });

        // Monitor messages
        if (window.PicassoWidget) {
            window.PicassoWidget.onEvent('message_sent', (data) => {
                const startTime = Date.now();
                addLogEntry(`ðŸ“¤ Message sent: "${data.message}"`, 'info');
                
                // Track response time
                window.PicassoWidget.onEvent('message_received', () => {
                    const responseTime = Date.now() - startTime;
                    metrics.lastMessageTime = responseTime;
                    document.getElementById('message-response').textContent = `${responseTime}ms`;
                    addLogEntry(`ðŸ“¥ Response received in ${responseTime}ms`, 'success');
                });
            });
        }

        // Initial log
        addLogEntry('ðŸš€ Dual-Path Architecture Test Suite Initialized', 'success');
        addLogEntry(`Testing with tenant: my87674d777bf9`, 'info');
    </script>
</body>
</html>