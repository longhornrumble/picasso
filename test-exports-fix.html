<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exports Error Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        iframe { border: 2px solid #007bff; border-radius: 8px; margin: 10px 0; }
        #console { background: #1e1e1e; color: #fff; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
        .code { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üß™ Testing "Unexpected token 'exports'" Fix</h1>
    
    <div class="test-section">
        <h2>üìä Test Results</h2>
        <div id="test-status" class="status info">üîÑ Initializing tests...</div>
        
        <h3>üîç What we're testing:</h3>
        <div class="code">
            <strong>Before fix (would cause error):</strong><br>
            script.src = '/iframe-main.js';  // ‚ùå ES module with exports token<br><br>
            
            <strong>After fix (should work):</strong><br>
            script.src = '/iframe-main.js';  // ‚úÖ IIFE format (no module type needed)<br>
            // No type="module" required for IIFE
        </div>
    </div>

    <div class="test-section">
        <h2>üéØ Direct Script Loading Test</h2>
        <p>Testing if iframe-main.js can be loaded as an IIFE script (no module type needed):</p>
        <div id="module-test-status" class="status info">‚è≥ Loading IIFE script...</div>
    </div>

    <div class="test-section">
        <h2>üì± Widget Iframe Test</h2>
        <p>Testing the actual widget frame with production mode:</p>
        <div id="iframe-status" class="status info">‚è≥ Loading iframe...</div>
        
        <!-- Force production mode by serving from a different origin -->
        <iframe 
            id="widget-iframe" 
            src="http://127.0.0.1:8080/widget-frame.html?t=test123" 
            width="400" 
            height="600" 
            title="Widget Test">
        </iframe>
    </div>

    <div class="test-section">
        <h2>üìù Console Output</h2>
        <div id="console"></div>
    </div>

    <script>
        const testStatus = document.getElementById('test-status');
        const moduleStatus = document.getElementById('module-test-status');
        const iframeStatus = document.getElementById('iframe-status');
        const consoleOutput = document.getElementById('console');
        const iframe = document.getElementById('widget-iframe');
        
        let hasExportsError = false;
        let moduleLoadSuccess = false;
        let iframeLoadSuccess = false;
        let errorCount = 0;

        function log(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            consoleOutput.textContent += `[${timestamp}] ${level.toUpperCase()}: ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function updateStatus() {
            if (hasExportsError) {
                testStatus.className = 'status error';
                testStatus.innerHTML = '‚ùå <strong>EXPORTS ERROR DETECTED!</strong><br>The "Unexpected token exports" error still occurs.';
            } else if (moduleLoadSuccess && iframeLoadSuccess) {
                testStatus.className = 'status success';
                testStatus.innerHTML = '‚úÖ <strong>ALL TESTS PASSED!</strong><br>IIFE script loading works correctly. The exports error is fixed.';
            } else if (errorCount > 0) {
                testStatus.className = 'status error';
                testStatus.innerHTML = `‚ö†Ô∏è <strong>ERRORS DETECTED:</strong> ${errorCount} error(s)<br>But no exports error found.`;
            } else {
                testStatus.className = 'status info';
                testStatus.innerHTML = `üîÑ <strong>Testing in progress...</strong><br>Module: ${moduleLoadSuccess ? '‚úÖ' : '‚è≥'}, Iframe: ${iframeLoadSuccess ? '‚úÖ' : '‚è≥'}`;
            }
        }

        // Override console to capture errors
        const originalError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');
            log('error', message);
            
            if (message.includes('Unexpected token') && message.includes('exports')) {
                hasExportsError = true;
                updateStatus();
            } else {
                errorCount++;
            }
            
            originalError.apply(console, args);
        };

        // Test 1: Direct ES module loading
        async function testDirectModuleLoading() {
            try {
                log('info', 'Testing direct IIFE script loading...');
                
                // Try to load the IIFE script directly
                const iframeScript = document.createElement('script');
                iframeScript.src = 'http://127.0.0.1:8080/iframe-main.js';
                iframeScript.onload = function() {
                    window.parent.postMessage({type: 'MODULE_LOAD_SUCCESS'}, '*');
                };
                iframeScript.onerror = function(error) {
                    window.parent.postMessage({type: 'MODULE_LOAD_ERROR', error: error.message || 'Script load failed'}, '*');
                };
                
                document.head.appendChild(iframeScript);
                
            } catch (error) {
                log('error', `Direct script loading failed: ${error.message}`);
                moduleStatus.className = 'status error';
                moduleStatus.innerHTML = '‚ùå Direct script loading failed';
            }
        }

        // Test 2: Listen for iframe messages
        window.addEventListener('message', (event) => {
            if (event.data.type === 'MODULE_LOAD_SUCCESS') {
                log('info', 'Direct IIFE script loading successful!');
                moduleLoadSuccess = true;
                moduleStatus.className = 'status success';
                moduleStatus.innerHTML = '‚úÖ IIFE script loads correctly (no exports error)';
                updateStatus();
            } else if (event.data.type === 'MODULE_LOAD_ERROR') {
                log('error', `Script load error: ${event.data.error}`);
                moduleStatus.className = 'status error';
                moduleStatus.innerHTML = `‚ùå IIFE script loading failed: ${event.data.error}`;
                updateStatus();
            } else if (event.data.type && event.data.type.startsWith('PICASSO_')) {
                log('info', `Iframe message received: ${event.data.type}`);
                iframeLoadSuccess = true;
                iframeStatus.className = 'status success';
                iframeStatus.innerHTML = '‚úÖ Widget iframe loaded and communicating';
                updateStatus();
            }
        });

        // Test 3: Monitor iframe loading
        iframe.addEventListener('load', () => {
            log('info', 'Iframe loaded successfully');
            setTimeout(() => {
                if (!iframeLoadSuccess) {
                    iframeStatus.className = 'status info';
                    iframeStatus.innerHTML = '‚è≥ Iframe loaded, waiting for widget to initialize...';
                }
            }, 2000);
        });

        iframe.addEventListener('error', (e) => {
            log('error', `Iframe failed to load: ${e}`);
            iframeStatus.className = 'status error';
            iframeStatus.innerHTML = '‚ùå Iframe failed to load';
            errorCount++;
            updateStatus();
        });

        // Start tests
        log('info', 'Starting exports error fix tests...');
        log('info', 'Testing with 127.0.0.1 to force production mode (not localhost)');
        
        setTimeout(testDirectModuleLoading, 1000);
        
        // Final check after 10 seconds
        setTimeout(() => {
            if (!hasExportsError && !moduleLoadSuccess && !iframeLoadSuccess) {
                testStatus.className = 'status info';
                testStatus.innerHTML = '‚è≥ <strong>Tests still running...</strong><br>Check console for detailed logs.';
            }
        }, 10000);
        
        updateStatus();
    </script>
</body>
</html> 