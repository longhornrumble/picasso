<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Picasso Mobile Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f0f0f0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .device-simulator {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .device-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .device-info div {
            margin: 5px 0;
        }
        
        .test-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .test-btn:active {
            background: #0056b3;
            transform: scale(0.98);
        }
        
        .test-btn.secondary {
            background: #6c757d;
        }
        
        .test-results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .result-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 13px;
        }
        
        .result-pass {
            background: #d4edda;
            color: #155724;
        }
        
        .result-fail {
            background: #f8d7da;
            color: #721c24;
        }
        
        .result-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .touch-indicator {
            position: fixed;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 123, 255, 0.5);
            pointer-events: none;
            transform: translate(-50%, -50%);
            transition: opacity 0.3s;
            opacity: 0;
            z-index: 10000;
        }
        
        .orientation-notice {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ffc107;
            color: #000;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            z-index: 10001;
        }
        
        @media (orientation: landscape) and (max-width: 768px) {
            .orientation-notice {
                display: block;
            }
        }
        
        .viewport-test {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
            font-family: monospace;
        }
        
        /* Test content for scrolling */
        .test-content {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .test-content h3 {
            margin-bottom: 10px;
        }
        
        .test-content p {
            line-height: 1.6;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="orientation-notice">
        üì± Rotate to portrait mode for best experience
    </div>
    
    <div class="touch-indicator" id="touchIndicator"></div>
    
    <div class="device-simulator">
        <h1>üì± Picasso Mobile Test</h1>
        
        <div class="device-info" id="deviceInfo">
            <div>Loading device info...</div>
        </div>
        
        <div class="test-controls">
            <button class="test-btn" onclick="testWidget()">üöÄ Test Widget</button>
            <button class="test-btn" onclick="testTouch()">üëÜ Test Touch</button>
            <button class="test-btn" onclick="testViewport()">üìê Test Viewport</button>
            <button class="test-btn" onclick="testScroll()">üìú Test Scroll</button>
            <button class="test-btn" onclick="testOrientation()">üîÑ Test Orientation</button>
            <button class="test-btn secondary" onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>
        
        <div class="viewport-test" id="viewportInfo">
            Viewport: calculating...
        </div>
        
        <div class="test-results" id="testResults">
            <div class="result-item result-info">Ready to test...</div>
        </div>
        
        <div class="test-content">
            <h3>Test Content Area</h3>
            <p>This is a test content area to verify scrolling behavior when the widget is open.</p>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
            <p>Scroll down to see more content and test how the widget behaves with page scrolling.</p>
            <p>The widget should remain fixed in position and not interfere with page scrolling.</p>
            <p>Additional content to make the page scrollable...</p>
            <p>More content...</p>
            <p>Even more content...</p>
            <p>Keep scrolling...</p>
            <p>Almost there...</p>
            <p>Last paragraph of test content.</p>
        </div>
    </div>

    <!-- Load widget from local dev server -->
    <script src="http://localhost:5173/widget.js" data-tenant="fo85e6a06dcdf4" data-dev="true"></script>
    
    <script>
        // Device info
        function updateDeviceInfo() {
            const info = {
                userAgent: navigator.userAgent,
                viewport: `${window.innerWidth} x ${window.innerHeight}`,
                orientation: screen.orientation ? screen.orientation.type : 'unknown',
                pixelRatio: window.devicePixelRatio,
                touchSupport: 'ontouchstart' in window,
                platform: navigator.platform
            };
            
            const deviceInfo = document.getElementById('deviceInfo');
            deviceInfo.innerHTML = `
                <div><strong>Platform:</strong> ${info.platform}</div>
                <div><strong>Viewport:</strong> ${info.viewport}</div>
                <div><strong>Orientation:</strong> ${info.orientation}</div>
                <div><strong>Pixel Ratio:</strong> ${info.pixelRatio}</div>
                <div><strong>Touch:</strong> ${info.touchSupport ? '‚úÖ Supported' : '‚ùå Not supported'}</div>
                <div><strong>User Agent:</strong> <small>${info.userAgent}</small></div>
            `;
            
            updateViewportInfo();
        }
        
        function updateViewportInfo() {
            const viewportInfo = document.getElementById('viewportInfo');
            viewportInfo.textContent = `Viewport: ${window.innerWidth} x ${window.innerHeight} | DPR: ${window.devicePixelRatio}`;
        }
        
        // Test result logging
        function logResult(test, status, message) {
            const results = document.getElementById('testResults');
            const result = document.createElement('div');
            result.className = `result-item result-${status}`;
            result.textContent = `[${test}] ${message}`;
            results.appendChild(result);
            results.scrollTop = results.scrollHeight;
        }
        
        function clearResults() {
            document.getElementById('testResults').innerHTML = '<div class="result-item result-info">Results cleared</div>';
        }
        
        // Test functions
        function testWidget() {
            logResult('Widget', 'info', 'Testing widget functionality...');
            
            try {
                if (window.PicassoWidget) {
                    // Test opening
                    window.PicassoWidget.open();
                    logResult('Widget', 'pass', 'Widget opened successfully');
                    
                    // Check if it's responsive
                    setTimeout(() => {
                        const isOpen = window.PicassoWidget.isOpen();
                        if (isOpen) {
                            logResult('Widget', 'pass', 'Widget state confirmed as open');
                            
                            // Test closing after 2 seconds
                            setTimeout(() => {
                                window.PicassoWidget.close();
                                logResult('Widget', 'pass', 'Widget closed successfully');
                            }, 2000);
                        } else {
                            logResult('Widget', 'fail', 'Widget state mismatch');
                        }
                    }, 500);
                } else {
                    logResult('Widget', 'fail', 'PicassoWidget not found');
                }
            } catch (error) {
                logResult('Widget', 'fail', `Error: ${error.message}`);
            }
        }
        
        function testTouch() {
            logResult('Touch', 'info', 'Testing touch interactions...');
            
            if ('ontouchstart' in window) {
                logResult('Touch', 'pass', 'Touch events supported');
                
                // Visual touch indicator
                let touchCount = 0;
                const indicator = document.getElementById('touchIndicator');
                
                const handleTouch = (e) => {
                    touchCount++;
                    const touch = e.touches[0];
                    indicator.style.left = touch.clientX + 'px';
                    indicator.style.top = touch.clientY + 'px';
                    indicator.style.opacity = '1';
                    
                    setTimeout(() => {
                        indicator.style.opacity = '0';
                    }, 300);
                    
                    logResult('Touch', 'info', `Touch ${touchCount} at ${Math.round(touch.clientX)}, ${Math.round(touch.clientY)}`);
                };
                
                document.addEventListener('touchstart', handleTouch, { once: true });
                logResult('Touch', 'info', 'Touch the screen to test touch tracking');
            } else {
                logResult('Touch', 'fail', 'Touch events not supported');
            }
        }
        
        function testViewport() {
            logResult('Viewport', 'info', 'Testing viewport behavior...');
            
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                logResult('Viewport', 'pass', `Viewport meta tag found: ${viewport.content}`);
            } else {
                logResult('Viewport', 'fail', 'No viewport meta tag found');
            }
            
            // Test zoom prevention
            const initialScale = window.visualViewport ? window.visualViewport.scale : 1;
            logResult('Viewport', 'info', `Current scale: ${initialScale}`);
            
            if (initialScale === 1) {
                logResult('Viewport', 'pass', 'No zoom detected');
            } else {
                logResult('Viewport', 'warn', `Page is zoomed to ${initialScale}x`);
            }
            
            // Test safe areas (for iPhone X and newer)
            const safeAreaInsets = {
                top: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sat') || '0'),
                bottom: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sab') || '0')
            };
            
            if (safeAreaInsets.top > 0 || safeAreaInsets.bottom > 0) {
                logResult('Viewport', 'info', `Safe area insets detected: top=${safeAreaInsets.top}px, bottom=${safeAreaInsets.bottom}px`);
            }
        }
        
        function testScroll() {
            logResult('Scroll', 'info', 'Testing scroll behavior...');
            
            // Test current scroll position
            const scrollY = window.scrollY;
            logResult('Scroll', 'info', `Current scroll position: ${scrollY}px`);
            
            // Test programmatic scroll
            window.scrollTo(0, 100);
            setTimeout(() => {
                const newScrollY = window.scrollY;
                if (newScrollY === 100) {
                    logResult('Scroll', 'pass', 'Programmatic scroll working');
                    window.scrollTo(0, 0);
                } else {
                    logResult('Scroll', 'fail', 'Programmatic scroll not working');
                }
            }, 100);
            
            // Test scroll while widget is open
            setTimeout(() => {
                window.PicassoWidget.open();
                logResult('Scroll', 'info', 'Widget opened - test page scroll');
                
                setTimeout(() => {
                    const scrollable = document.body.scrollHeight > window.innerHeight;
                    if (scrollable) {
                        logResult('Scroll', 'pass', 'Page remains scrollable with widget open');
                    } else {
                        logResult('Scroll', 'info', 'Page not tall enough to scroll');
                    }
                    window.PicassoWidget.close();
                }, 1000);
            }, 500);
        }
        
        function testOrientation() {
            logResult('Orientation', 'info', 'Testing orientation handling...');
            
            if (screen.orientation) {
                const currentOrientation = screen.orientation.type;
                logResult('Orientation', 'pass', `Current orientation: ${currentOrientation}`);
                
                // Listen for orientation changes
                screen.orientation.addEventListener('change', () => {
                    logResult('Orientation', 'info', `Orientation changed to: ${screen.orientation.type}`);
                    updateDeviceInfo();
                }, { once: true });
                
                logResult('Orientation', 'info', 'Rotate device to test orientation change');
            } else {
                logResult('Orientation', 'fail', 'Screen orientation API not supported');
            }
            
            // Test CSS media queries
            const isPortrait = window.matchMedia('(orientation: portrait)').matches;
            const isLandscape = window.matchMedia('(orientation: landscape)').matches;
            
            logResult('Orientation', 'info', `Media queries: portrait=${isPortrait}, landscape=${isLandscape}`);
        }
        
        // Initialize
        window.addEventListener('load', () => {
            updateDeviceInfo();
            
            // Update on resize
            window.addEventListener('resize', updateDeviceInfo);
            
            // Visual viewport changes (zoom, keyboard, etc.)
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    logResult('Viewport', 'info', `Visual viewport resized: ${window.visualViewport.width} x ${window.visualViewport.height}`);
                });
            }
            
            // Test initial widget health
            setTimeout(() => {
                if (window.PicassoWidget && window.PicassoWidget.health) {
                    const health = window.PicassoWidget.health();
                    logResult('Init', health.healthy ? 'pass' : 'fail', 
                        `Widget health check: ${health.healthy ? 'Healthy' : 'Unhealthy'}`);
                }
            }, 1000);
        });
        
        // Prevent pull-to-refresh on mobile
        document.addEventListener('touchmove', (e) => {
            if (e.touches[0].clientY > 0) {
                // Allow scrolling
            }
        }, { passive: true });
    </script>
</body>
</html>