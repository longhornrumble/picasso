<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Staging Test - Picasso Widget</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .tenant-selector {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #0066cc;
        }
        .tenant-selector h2 {
            margin-top: 0;
            color: #0066cc;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            font-family: monospace;
        }
        .input-group button {
            padding: 10px 20px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            white-space: nowrap;
        }
        .input-group button:hover {
            background: #0052a3;
        }
        .quick-select {
            margin-top: 10px;
        }
        .quick-select button {
            margin-right: 10px;
            margin-bottom: 10px;
            padding: 8px 15px;
            background: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .quick-select button:hover {
            background: #d0d0d0;
        }
        .current-tenant {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #4caf50;
            display: none;
        }
        .current-tenant code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        .test-section h3 {
            margin-top: 0;
            color: #666;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 14px;
            font-weight: bold;
        }
        .status.success {
            background: #4caf50;
            color: white;
        }
        .status.error {
            background: #f44336;
            color: white;
        }
        .status.loading {
            background: #ff9800;
            color: white;
        }
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .actions button {
            padding: 10px 20px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .actions button:hover {
            background: #0052a3;
        }
        .actions button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .mobile-instructions {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border: 1px solid #ffc107;
        }
        .mobile-instructions h4 {
            margin-top: 0;
            color: #856404;
        }
        .mobile-instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        /* Widget container for isolation */
        #widget-container {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dynamic Staging Test - Picasso Widget</h1>

        <div class="tenant-selector">
            <h2>Select or Enter Tenant</h2>
            <div class="input-group">
                <input 
                    type="text" 
                    id="tenant-input" 
                    placeholder="Enter tenant hash (e.g., fo85e6a06dcdf4)" 
                    value="fo85e6a06dcdf4"
                >
                <button onclick="loadWidget()">Load Widget</button>
            </div>
            <div class="quick-select">
                <strong>Quick select:</strong><br>
                <button onclick="setTenant('fo85e6a06dcdf4')">Foster Village</button>
                <button onclick="setTenant('test-tenant-staging')">Test Tenant</button>
                <button onclick="setTenant('demo-tenant-123')">Demo Tenant</button>
            </div>
        </div>

        <div id="current-tenant" class="current-tenant">
            <strong>Currently Testing:</strong> <code id="current-tenant-hash">None</code>
        </div>

        <div class="test-section">
            <h3>Widget Status</h3>
            <div id="widget-status" class="status loading">No widget loaded</div>
            <div id="widget-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>Configuration</h3>
            <div id="config-status" class="status loading">Waiting...</div>
            <div id="config-log" class="log"></div>
        </div>

        <div class="actions" id="widget-actions" style="display: none;">
            <button onclick="window.PicassoWidget && window.PicassoWidget.open()">Open Chat</button>
            <button onclick="window.PicassoWidget && window.PicassoWidget.close()">Close Chat</button>
            <button onclick="window.PicassoWidget && window.PicassoWidget.toggle()">Toggle Chat</button>
            <button onclick="checkState()">Check State</button>
        </div>

        <div class="mobile-instructions">
            <h4>ðŸ“± Mobile Testing</h4>
            <ol>
                <li>Open DevTools (F12) and toggle device mode (Ctrl/Cmd+Shift+M)</li>
                <li>Select a mobile device preset (e.g., iPhone 12 Pro)</li>
                <li>Load a tenant and verify:
                    <ul>
                        <li>Toggle button at bottom-right (20px from edges)</li>
                        <li>Full-screen chat when opened</li>
                        <li>Proper tenant branding displayed</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <!-- Dynamic widget container -->
    <div id="widget-container"></div>

    <script>
        let currentWidget = null;

        // Logging function
        function log(elementId, message) {
            const logEl = document.getElementById(elementId);
            if (!logEl) return;
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${timestamp}] ${message}<br>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('widget-log').innerHTML = '';
            document.getElementById('config-log').innerHTML = '';
        }

        // Update status
        function updateStatus(elementId, status, text) {
            const statusEl = document.getElementById(elementId);
            if (!statusEl) return;
            statusEl.className = 'status ' + status;
            statusEl.textContent = text;
        }

        // Set tenant in input
        function setTenant(hash) {
            document.getElementById('tenant-input').value = hash;
            log('widget-log', `Selected tenant: ${hash}`);
        }

        // Check widget state
        function checkState() {
            if (window.PicassoWidget) {
                const isOpen = window.PicassoWidget.isOpen();
                alert(`Widget is ${isOpen ? 'OPEN' : 'CLOSED'}`);
                log('config-log', `State check: Widget is ${isOpen ? 'open' : 'closed'}`);
            } else {
                alert('No widget loaded');
            }
        }

        // Load widget with specified tenant
        function loadWidget() {
            const tenantHash = document.getElementById('tenant-input').value.trim();
            if (!tenantHash) {
                alert('Please enter a tenant hash');
                return;
            }

            // Clear previous widget
            clearLogs();
            const container = document.getElementById('widget-container');
            container.innerHTML = '';
            
            // Remove any existing widget elements
            const existingWidget = document.querySelector('[data-widget="picasso-chat"]');
            const existingToggle = document.querySelector('[data-widget="picasso-toggle"]');
            if (existingWidget) existingWidget.remove();
            if (existingToggle) existingToggle.remove();
            
            // Reset PicassoWidget global
            if (window.PicassoWidget) {
                delete window.PicassoWidget;
            }

            log('widget-log', `Loading widget for tenant: ${tenantHash}`);
            
            // Create new script element
            const script = document.createElement('script');
            script.src = 'https://chat.myrecruiter.ai/staging/widget.js';
            script.setAttribute('data-tenant', tenantHash);
            
            // Add load handlers
            script.onload = () => {
                log('widget-log', 'Widget script loaded successfully');
                updateStatus('widget-status', 'success', 'Script Loaded');
                
                // Show current tenant
                document.getElementById('current-tenant').style.display = 'block';
                document.getElementById('current-tenant-hash').textContent = tenantHash;
                
                // Check for widget initialization
                setTimeout(() => {
                    if (window.PicassoWidget) {
                        log('config-log', 'PicassoWidget initialized');
                        log('config-log', 'Methods: ' + Object.keys(window.PicassoWidget).join(', '));
                        updateStatus('config-status', 'success', 'Widget Ready');
                        
                        // Enable action buttons
                        document.getElementById('widget-actions').style.display = 'flex';
                        
                        // Listen for events
                        window.PicassoWidget.onEvent((event, data) => {
                            log('config-log', `Event: ${event}`);
                        });
                    } else {
                        log('config-log', 'PicassoWidget not found after timeout');
                        updateStatus('config-status', 'error', 'Not Initialized');
                    }
                    
                    // Check DOM elements
                    const toggle = document.querySelector('[data-widget="picasso-toggle"]');
                    if (toggle) {
                        const styles = window.getComputedStyle(toggle);
                        log('widget-log', `Toggle rendered - Position: ${styles.position}, Bottom: ${styles.bottom}, Right: ${styles.right}`);
                    } else {
                        log('widget-log', 'Toggle button not found in DOM');
                    }
                }, 2000);
            };
            
            script.onerror = () => {
                log('widget-log', 'Failed to load widget script');
                updateStatus('widget-status', 'error', 'Load Failed');
            };
            
            // Append script to container
            container.appendChild(script);
        }

        // Listen for errors
        window.addEventListener('error', (e) => {
            if (e.message.includes('Picasso') || e.filename.includes('widget')) {
                log('widget-log', `Error: ${e.message}`);
            }
        });

        // Auto-load Foster Village on page load
        window.addEventListener('load', () => {
            log('widget-log', 'Page ready - click "Load Widget" to test a tenant');
            updateStatus('widget-status', 'loading', 'Ready to load');
        });
    </script>
</body>
</html>