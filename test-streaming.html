<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Picasso Streaming Test - Force Enabled</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .info {
            background: #f0f4f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .status.success { background: #10b981; color: white; }
        .status.warning { background: #f59e0b; color: white; }
        .status.error { background: #ef4444; color: white; }
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .button:hover {
            background: #5a67d8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Picasso Widget - Streaming Test</h1>
        
        <div class="info">
            <h3>Streaming Controls:</h3>
            <button class="button" onclick="enableStreaming()">Enable Streaming</button>
            <button class="button" onclick="testStreaming()">Test Streaming Message</button>
            <button class="button" onclick="openChat()">Open Chat</button>
        </div>

        <div class="info">
            <h3>Test Instructions:</h3>
            <ol>
                <li>Click "Enable Streaming" button first</li>
                <li>Click "Open Chat" or click the widget bubble</li>
                <li>Ask: "What programs do you offer?"</li>
                <li>Watch for incremental streaming response</li>
            </ol>
        </div>

        <div class="info">
            <h3>Status:</h3>
            <p>Tenant: <span class="status success">my87674d777bf9</span> (MyRecruiter/Civitas)</p>
            <p>Environment: <span class="status warning">Development (Forced Streaming)</span></p>
            <p>Lambda: <span class="status success">Bedrock_Streaming_Handler_Staging</span></p>
            <p>KB ID: <span class="status success">0BQBWFYDMT</span></p>
        </div>

        <div class="info">
            <h3>Console Output:</h3>
            <pre id="console-output" style="background: #1a1a1a; color: #0f0; padding: 10px; border-radius: 4px; font-size: 12px; max-height: 200px; overflow-y: auto;">Waiting for widget to load...</pre>
        </div>
    </div>

    <!-- Load Picasso Widget with development build (cache bust) -->
    <script src="/dist/development/widget.js?v=2" data-tenant="my87674d777bf9"></script>
    
    <script>
        const log = (msg, type = 'info') => {
            const output = document.getElementById('console-output');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f44' : type === 'success' ? '#4f4' : '#0f0';
            output.innerHTML += `<div style="color: ${color}">[${time}] ${msg}</div>`;
            output.scrollTop = output.scrollHeight;
            console.log(`[Streaming Test] ${msg}`);
        };

        // Enable streaming when iframe loads
        const enableStreaming = () => {
            const iframe = document.querySelector('iframe[id*="picasso"]');
            if (iframe && iframe.contentWindow) {
                // Try to enable streaming in the iframe
                iframe.contentWindow.postMessage({
                    type: 'ENABLE_STREAMING',
                    force: true
                }, '*');
                
                // Also try direct method if available
                if (iframe.contentWindow.enablePicassoStreaming) {
                    iframe.contentWindow.enablePicassoStreaming();
                    log('Streaming enabled via direct method', 'success');
                } else {
                    log('Attempting to enable streaming via postMessage', 'info');
                }

                // Set localStorage flag
                localStorage.setItem('picasso_streaming_enabled', 'true');
                localStorage.setItem('picasso_streaming_force', 'true');
                log('Streaming flags set in localStorage', 'success');
            } else {
                log('Widget iframe not found - wait for it to load first', 'error');
            }
        };

        const testStreaming = () => {
            const iframe = document.querySelector('iframe[id*="picasso"]');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({
                    type: 'TEST_STREAMING',
                    message: 'What programs do you offer?'
                }, '*');
                log('Sent test streaming message', 'info');
            }
        };

        const openChat = () => {
            if (window.PicassoWidget) {
                window.PicassoWidget.open();
                log('Chat opened', 'success');
                setTimeout(enableStreaming, 500); // Enable streaming after opening
            } else {
                log('Widget not loaded', 'error');
            }
        };

        // Listen for widget events
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'PICASSO_EVENT') {
                log(`Widget Event: ${event.data.event}`, 'info');
                
                // Auto-enable streaming when chat opens
                if (event.data.event === 'CHAT_OPENED') {
                    setTimeout(enableStreaming, 500);
                }
            }
        });
        
        // Check widget load status
        setTimeout(() => {
            if (window.PicassoWidget) {
                log('Widget loaded successfully', 'success');
                log('Available methods: ' + Object.keys(window.PicassoWidget).join(', '), 'info');
                
                // Pre-set streaming flags
                localStorage.setItem('picasso_streaming_enabled', 'true');
                localStorage.setItem('picasso_streaming_force', 'true');
                log('Pre-configured streaming flags', 'success');
            } else {
                log('Widget failed to load', 'error');
            }
        }, 2000);

        // Auto-enable streaming on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('Auto-enabling streaming...', 'info');
                enableStreaming();
            }, 3000);
        });
    </script>
</body>
</html>