<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1D4ED8" />
    
    <title>Picasso Widget</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" /></noscript>
    
    <style>
      *,*::before,*::after{box-sizing:border-box;}
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        font-family: Inter, system-ui, -apple-system, sans-serif;
        background: transparent;
      }
      
      #root {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      
      .loading-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        background: #f8f9fa;
        color: #6c757d;
        font-family: Inter, system-ui, -apple-system, sans-serif;
        font-size: 14px;
      }
      
      .spinner{width:32px;height:32px;border:3px solid #f3f4f6;border-radius:50%;border-top-color:#1d4ed8;animation:spin 1s ease-in-out infinite;margin-bottom:10px;}
      @keyframes spin{to{transform:rotate(360deg);}}
    </style>
  </head>
<body>
  <div id="root">
    <div class="loading-indicator">
      üé® Loading Picasso Widget...
    </div>
  </div>
  
  <!-- Manual React Refresh preamble injection for iframe context -->
  <script type="module">
    // Check if we're in development (localhost)
    const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    
    if (isLocalDev) {
      (async () => {
        try {
          // Import and inject React Refresh runtime from Vite dev server
          const RefreshRuntime = await import('http://localhost:5174/@react-refresh');
          RefreshRuntime.injectIntoGlobalHook(window);
          
          // Set up required globals for React Refresh
          window.$RefreshReg$ = () => {};
          window.$RefreshSig$ = () => (type) => type;
          window.__vite_plugin_react_preamble_installed__ = true;
          
          console.log('‚úÖ React Refresh preamble injected successfully');
        } catch (error) {
          console.log('‚ö†Ô∏è React Refresh not available (normal in production):', error.message);
        }
      })();
    }
  </script>
  
  <!-- Vite client for HMR (development only) -->
  <script type="module">
    // Check if we're in development (localhost) for Vite client
    const isDevMode = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    
    if (isDevMode) {
      const script = document.createElement('script');
      script.type = 'module';
      script.src = 'http://localhost:5174/@vite/client';
      script.onerror = () => console.log('‚ö†Ô∏è Vite client not available');
      document.head.appendChild(script);
    }
  </script>

  <script>
    // Debug URL parameters
    console.log('üîç Current URL:', window.location.href);
    console.log('üîç URL Parameters:', new URLSearchParams(window.location.search).toString());
    const urlParams = new URLSearchParams(window.location.search);
    const tenantHash = urlParams.get('t');
    console.log('üîë Detected tenant hash from URL:', tenantHash || 'none');
    
    // Communication bridge with parent window
    function notifyParent(data) {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: 'PICASSO_WIDGET',
          ...data
        }, '*');
      }
    }

    // Monitor chat state changes for iframe resizing
    function setupStateMonitoring() {
      console.log('üîß Setting up state monitoring...');
      
      // Ensure document.body exists and is properly initialized
      if (!document || !document.body || typeof document.body.classList === 'undefined') {
        console.warn('‚ö†Ô∏è Document body not ready for state monitoring, retrying in 100ms');
        setTimeout(setupStateMonitoring, 100);
        return;
      }
      
      let lastOpenState = null;
      
      // Function to check and notify state changes
      function checkStateChange() {
        try {
          const isOpen = document.body.classList.contains('chat-open');
          if (isOpen !== lastOpenState) {
            lastOpenState = isOpen;
            notifyParent({
              action: 'SIZE_CHANGE',
              isOpen: isOpen,
              size: isOpen ? { width: 360, height: 640 } : { width: 56, height: 56 }
            });
            console.log(`üìè State changed: ${isOpen ? 'OPEN' : 'CLOSED'}`);
          }
        } catch (error) {
          console.warn('‚ö†Ô∏è Error checking state:', error);
        }
      }
      
      // Try MutationObserver first (preferred)
      if (typeof MutationObserver !== 'undefined') {
        try {
          const observer = new MutationObserver((mutations) => {
            for (const mutation of mutations) {
              if (mutation.type === 'attributes' && 
                  mutation.attributeName === 'class' && 
                  mutation.target === document.body) {
                checkStateChange();
                break;
              }
            }
          });

          observer.observe(document.body, {
            attributes: true,
            attributeFilter: ['class'],
            subtree: false
          });
          
          console.log('‚úÖ MutationObserver setup successfully');
        } catch (error) {
          console.warn('‚ö†Ô∏è MutationObserver failed, falling back to polling:', error);
          // Fallback to polling
          setInterval(checkStateChange, 200);
        }
      } else {
        console.log('üìä Using polling fallback for state monitoring');
        setInterval(checkStateChange, 200);
      }
      
      // Initial state check
      setTimeout(checkStateChange, 100);
    }

    // Initialize monitoring when DOM is ready
    function initializeWhenReady() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          console.log('‚úÖ DOM loaded, setting up monitoring');
          setTimeout(setupStateMonitoring, 50); // Small delay to ensure everything is ready
        });
      } else {
        console.log('‚úÖ DOM already ready, setting up monitoring');
        setTimeout(setupStateMonitoring, 50);
      }
    }
    
    // Initialize
    initializeWhenReady();
    
    // Dynamically load the iframe script based on environment
    function loadIframeScript() {
  if (!document.head) {
    console.error('‚ùå Document head not available for script loading');
    return;
  }
  
  const script = document.createElement('script');
  script.type = 'module';  // Always set module type
  
  const isLocalDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
  
  if (isLocalDevelopment) {
    // Development mode - load from Vite dev server (always port 5174)
    script.src = 'http://localhost:5174/src/iframe-main.jsx';
    console.log('üöÄ Loading iframe script from Vite dev server:', script.src);
  } else {
    // Production mode - load built version
    script.src = '/iframe-main.js';
    console.log('üöÄ Loading iframe script from production:', script.src);
  }
  
  script.onerror = function() {
    console.error('‚ùå Failed to load iframe script:', script.src);
  };
  
  script.onload = function() {
    console.log('‚úÖ Iframe script loaded:', script.src);
  };
  
  setTimeout(() => {
    try {
      document.head.appendChild(script);
      console.log('‚úÖ Script appended to head');
    } catch (error) {
      console.error('‚ùå Failed to append script:', error);
    }
  }, 100);
}
    
    // Load the script after preamble setup
    loadIframeScript();
    
    // In widget-frame.html, dynamically load the CSS based on environment
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    
    if (isLocalhost) {
      // Development mode - load CSS from Vite dev server (port 5174)
      const viteDevServer = 'http://localhost:5174';
      console.log('üé® Loading CSS from Vite dev server:', viteDevServer);
      
      // Import CSS via Vite module system
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = `${viteDevServer}/src/styles/theme.css`;
      link.onerror = () => console.warn('‚ö†Ô∏è Could not load dev CSS');
      link.onload = () => console.log('‚úÖ CSS loaded from Vite dev server');
      document.head.appendChild(link);
    } else {
      // Production mode - find and load the theme CSS file
      fetch('/').then(r => r.text()).then(html => {
        const cssMatch = html.match(/theme-[^"]+\.css/);
        if (cssMatch) {
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = `/${cssMatch[0]}`;
          document.head.appendChild(link);
        }
      }).catch(e => console.warn('‚ö†Ô∏è Could not load production CSS:', e));
    }
  </script>
</body>
</html> 